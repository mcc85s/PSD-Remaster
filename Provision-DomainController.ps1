# ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\   ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯   //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//  [ Secure Digits Plus LLC | Hybrid | Desired State Controller ]  \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯     ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯     ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯                 Dynamically Engineered Digital Security                    ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\                    ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯                       //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//   Application Development | Virtualization | Network and Hardware Magistration   \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯   //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//   https://www.securedigitsplus.com | Server-Client | Seedling-Spawning Script    \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\___¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ ___//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\   [ Provisional Author : Michael C Cook Sr. | "The Buck Stops Here" ]    //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//   ____    ____    ____    ____    ____    ____    ____    ____    ____   \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯  
#\\  [ Provision-DomainController ] @: Orchestrates the process of provisioning server prerequisites in order to install Hybrid-DSC 
#//   ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____      
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\___  
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
# ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯  
    
    "Security.Principal" , "Management.Automation" | % { IEX "Using Namespace System.$_" }
    
    $ENV:PSModulePath.Split( ';' ) | % { GCI $_ -Recurse "Hybrid-DSC.psm1" } | % { 
        
        IPMO $_.FullName
        
        If ( $? -ne $True ) { Write-Error "Module Not Loaded/Found" }
        
        Sleep 1 
    }

# ____                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____  
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
    Function Auth-Cred # Tests credential for AD Authentication                   ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯ 
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯      

        [ CmdLetBinding () ][ OutputType ( [ Int ] ) ] Param ( 
        
            [ Parameter ( ValueFromPipeLine = $True , ValueFromPipelineByPropertyName = $True ) ][ Alias ( 'PSCredential' ) ]
            [ ValidateNotNull () ][ PSCredential ][ Credential () ] $Creds ,
            [ Parameter ( Position = 0 , ValueFromPipeLine = $True )][ Int ] $Port = 389 )

        $NBInfo = Get-NetBIOSServices

        ForEach ( $i in Get-NetworkInfo -NetBIOS -Full )
        {
            $NBInfo | ? { $_.ID -eq $I.ID -and $_.Type -eq $I.Type } | % { 
                $DomInfo += [ PSCustomObject ]@{ Name = $I.Name ; ID = $I.ID ; Type = $I.Type ; Service = $_.Service }
            }
        }

        Echo $DomInfo


        Try   { $DC  = Get-NetworkInfo -DNS | ? { $_ -ne $Null } ; $Dom = Get-Domain | ? { $_ -ne $Null }
                $AD  = "LDAP://$( $DC ):$Port/DC=$( $Dom.Split('.') -join ',DC=' )"
                $Creds | % { $DX = [ DirectoryEntry ]::New( "$AD" , $_.Username , $_.GetNetworkCredential().Password ) } }

        Catch { $_.Exception.Message ; Continue } Return $( If ( ! $DX ) { 0 } ElseIf ( $DX.Name -ne $Null ) { 1 } Else { 0 } )

    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____  
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
    Function Determine-Domain # A switch that determines workgroup or domain      ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯ 
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯      

        Return $( If ( ( GWMI Win32_ComputerSystem ).PartOfDomain -eq $True ) { $env:USERDOMAIN } Else { $ENV:ComputerName } )

    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____  
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
    Function Get-FeatureList # Collects all server features that pertain to DSC   ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯ 
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯      
        
        Return @( @( "AD-Domain-Services" , "DHCP" , "DNS" , "GPMC" ) ; @( "" ; @( "-AdminCenter" , "-PowerShell" , "-Tools" | % { "-AD$_" } ) + 
        @( "" , "-Tools" | % { "-ADDS$_" } ) + "-DHCP" , "-DNS-Server" , "-Role-Tools" ) | % { "RSAT$_" } ;
        @( "" , "-Deployment" , "-Transport" , "-AdminPack" | % { "WDS$_" } ) )

    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____ 
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
    Function Collect-FeaturesState # Determines Installation Loadout              ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯ 
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯      

        [ CmdLetBinding () ] Param ( [ Parameter () ][ Switch ] $All )

        $Services = Get-FeatureList ; $GWF = Get-WindowsFeature ; $Array = @( ) ; $Table = [ Ordered ]@{ Installed = @( ) ; Available = @( ) }

        ForEach ( $I in $Services ) { $X = $GWF | ? { $_.Name -eq $I } | % { 
            If ( $_.InstallState -ne "Installed" ) { $Array += "$I [_]" ; $Table.Available += "$I [_]" }
            If ( $_.InstallState -eq "Installed" ) { $Array += "$I [X]" ; $Table.Installed += "$I [X]" } } }

        Return $( If ( !$All ) { $Table } If (  $All ) { $Array } )

    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____ 
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//
    Function Collect-Certificate # Accesses Internet API's to recover Settings    ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯   
        
        [ CmdLetBinding () ] Param ( 
        
            [ Parameter ( Position = 0 , Mandatory = $True , ValueFromPipeline = $True ) ][ Alias (  "C" ) ][ String ] $Company   ,
            [ Parameter ( Position = 1 ,                     ValueFromPipeline = $True ) ][ Alias (  "D" ) ][ String ] $Domain    ,
            [ Parameter ( Position = 2 ,                     ValueFromPipeline = $True ) ][ Alias ( "TZ" ) ][ Switch ] $TimeZone  )

        If ( !$Domain ) { $Domain = Get-NetworkInfo -DNS } ; [ Net.ServicePointManager ]::SecurityProtocol = [ Net.SecurityProtocolType ]::Tls12

        $X = IRM -URI "http://ipinfo.io/$( ( IWR -URI 'http://ifconfig.me/ip' ).Content )" # Obtain External IP Address

        $Info  = [ PSCustomObject ]@{ IP = $X.IP ; ST = $X.Region ; O = $Company ; CN = $Domain  ; L = $X.City ; C = $X.Country ; Z = $X.Postal ; TZ = $X.TimeZone } 
        
        $Key = "tZqSUOHxpjLy9kyOLKspvyZmjciB0nWpxz6PMl3KQNQBNEnW5sCbTKkKBPalSOBk"

        IRM -URI "https://www.zipcodeapi.com/rest/$Key/info.json/$( $X.Postal )/degrees" -Method Get | % {
            $Info.L = "$( ( $_.City.Split(' ') | % { $_.Substring( 0 , 1 ) } ) -join '' )-$( $X.Postal )" }

        Return $Info

    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____  
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
    Function Enter-ServiceAccount # Allows entry / use of an AD service account   ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯   

        $XAML = @"
        <Window                       xmlns =                 "http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                                    xmlns:x =                              "http://schemas.microsoft.com/winfx/2006/xaml" 
                                      Title =                   "Secure Digits Plus LLC | Hybrid @ Enter Service Account" 
                                      Width =                                                                       "350" 
                                     Height =                                                                       "220" 
                                 ResizeMode =                                                                  "NoResize" 
                      WindowStartupLocation =                                                              "CenterScreen" 
                                    Topmost =                                                                      "True" >
            <GroupBox 
                                     Header =                           "Enter Directory Services Administration Account" 
                                      Width =                                                                       "330" 
                                     Height =                                                                       "180" >
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height = "3*" />
                        <RowDefinition Height =  "*" />
                        </Grid.RowDefinitions>
                    <Grid Grid.Row = "0" >
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width =    "*" />
                            <ColumnDefinition Width = "2.5*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition   Height = "*" />
                            <RowDefinition   Height = "*" />
                            <RowDefinition   Height = "*" />
                        </Grid.RowDefinitions>
                            <TextBlock                     Grid.Column = "0" Grid.Row = "0" Margin = "10" TextAlignment = "Right" >Username:</TextBlock>
                            <TextBlock                     Grid.Column = "0" Grid.Row = "1" Margin = "10" TextAlignment = "Right" >Password:</TextBlock>
                            <TextBlock                     Grid.Column = "0" Grid.Row = "2" Margin = "10" TextAlignment = "Right" >Confirm:</TextBlock>
                            <TextBox     Name = "Username" Grid.Column = "1" Grid.Row = "0" Height = "24" Margin = "5" ></TextBox>
                            <PasswordBox Name = "Password" Grid.Column = "1" Grid.Row = "1" Height = "24" Margin = "5" PasswordChar = "*" ></PasswordBox>
                            <PasswordBox Name =  "Confirm" Grid.Column = "1" Grid.Row = "2" Height = "24" Margin = "5" PasswordChar = "*" ></PasswordBox>
                    </Grid>
                    <Grid Grid.Row = "1" >
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width = "*" />
                            <ColumnDefinition Width = "*" />
                        </Grid.ColumnDefinitions>
                            <Button      Name =      "Ok" Content =     "Ok" Grid.Column = "0" Margin = "10" ></Button>
                            <Button      Name =  "Cancel" Content = "Cancel" Grid.Column = "1" Margin = "10" ></Button>
                    </Grid>
                </Grid>
            </GroupBox>
        </Window>
"@
        $NamedElements = "Username" , "Password" , "Confirm" , "Ok" , "Cancel"

        $0 = "Username" , "Password" , "Confirmation" ; $1 = $0 | % { "You must enter a $_" } ; $2 = $0 | % { "$_ Error" }
        $1[2] = $1[2].Replace( "You must enter a" , "Password Must Match the" ) 
        $1   += "Invalid/Incorrect. Try again, or cancel to exit" ; $2 += "Authentication Failure"

        $MSG  = 0..3 | % { "[ System.Windows.MessageBox ]::Show( '$( $1[$_] )' , '$( $2[$_] )' )" }
        
        # - [ Launch Window ] - #

        $GUI = Convert-XAMLtoWindow -Xaml $Xaml -NE $NamedElements -PassThru

        $GUI.Cancel.Add_Click({ $GUI.DialogResult = $False })

        $GUI.Ok.Add_Click({ 
            
            If     ( $GUI.Username.Text            -eq $Null )                 { IEX $MSG[0] } 
            ElseIf ( $GUI.Password.Password        -eq $Null )                 { IEX $MSG[1] }
            ElseIf (  $GUI.Confirm.Password        -eq $Null )                 { IEX $MSG[2] } 
            ElseIf ( $GUI.Password.Password  -notmatch $GUI.Confirm.Password ) { IEX $MSG[2] }

            ElseIf ( ( [ PSCredential ]::New( $GUI.Username.Text , $GUI.Password.SecurePassword ) | Auth-Cred ) -ne 1 ) { IEX $MSG[3] }

            Else   
            { $GUI.DialogResult = $True }
        })

        $Null = $GUI.Username.Focus()

        # - [ Instantiate the Window ] - #

        $OP = Show-WPFWindow -GUI $GUI
        
        If ( $OP -eq $True ) { Return [ PSCredential ]::New( $GUI.Username.Text , $GUI.Password.SecurePassword ) }

        Else { Write-Echo -Action "Exception" "Either the user cancelled, or the dialogue failed" -F 12 }

    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____ 
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//
    Function Provision-DomainController                                          #¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯   
        # - [ Glossary ] - #

        $Center = "VerticalContentAlignment = 'Center' HorizontalContentAlignment = 'Center'"
        $Schema = "http://schemas.microsoft.com/winfx/2006/xaml"
        $Author = "Secure Digits Plus LLC"
        $Select = "IsSelected = 'True"
        $Enable = "IsEnabled = 'False"

        $GR = 0..10 | % { "Grid.Row = '$_'" } ; $GC = 0..10 | % { "Grid.Column = '$_'" }
        $CS = ( GCIM Win32_OperatingSystem ).Caption

        $ED = @( ) ; $On = 1

        "2003" , "2008" , "2008 R2" , "2012" , "2012 R2" , "2016"  | % {

            If ( $On -eq 0 ) { $ED += "Server $_" }
            If ( $On -eq 1 )
            {
                If ( $_    -like "*R2*" ) { If ( $CS -like "*$_*" ) { $ED += "Server $_' $Select" } Else { $ED += "Server $_' $Enable" } }
                If ( $_ -notlike "*R2*" ) { If ( ( $CS -like "*$_*" ) -and ( $CS -notlike "*R2*" ) ) { $ED += "Server $_' $Select" } Else { $ED += "Server $_' $Enable" } }
                If ( ( $ED | ? { $_ -like "*IsSelected*" } ) -ne $Null ) { $On = 0 }
            }
        }

        $Default = $( If ( ( $ED | ? { $_ -like "*IsSelected*" } ) -eq $Null ) { "( Default )' $Select" } Else { "( Default )' $Enable" } )

        $List = @( Collect-FeaturesState -All ) | % { "
                        $_<LineBreak/>" }

        $ID = ( "ForestMode" , 0 , 0 ) , ( "DomainMode" , 1 , 0 ) 
        $YZ = $ID | % { "    <ComboBox Name = '$( $_[0] )' Grid.Row = '$( $_[1] )' Grid.Column = '$( $_[2] )' Height = '24' >" }

        ForEach ( $x in 0..1 ) 
        {
            $Y = @( )
            $Items = @( $YZ[$X] , "$( $ID[$X][0] ) $Default" ; @( $ED | % { "$_" } ) )
            
            0..8 | % { 

                If ( $_ -eq    0 ) { $Y += "$( $Items[$_] )
                " }

                If ( $_ -in 1..7 ) { $Y += "                       <ComboBoxItem Content = '$( $Items[$_] )' ></ComboBoxItem>
                " }

                If ( $_ -eq    8 ) { $Y += "                   </ComboBox>" }
            }

            If ( $X -eq 0 ) { $T0 = $Y } If ( $X -eq 1 ) { $T1 = $Y } ; $Y = $Null
        }

        $Xaml = @"
<Window                                           
                                                  xmlns = "$Schema/presentation"
                                                xmlns:x = "$Schema" 
                                                  Title = "$Author | Hybrid - Desired State Controller Installation" 
                                                  Width = "800" 
                                                 Height = "600" 
                                    HorizontalAlignment = "Center" 
                                  WindowStartupLocation = "CenterScreen" 
                                                Topmost = "True" >
    <GroupBox                                    
                                                 Header = "[ Hybrid-DSC Initial Service Configuration ]" 
                                    HorizontalAlignment = "Center" 
                                      VerticalAlignment = "Center" 
                                                  Width = "760" 
                                                 Height = "540" 
                                                 Margin = "10" >
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width =  "*" /><ColumnDefinition Width = "2.5*" />
            </Grid.ColumnDefinitions>
            <GroupBox Grid.Column = "0" Header = "Feature List" Margin = "10" >
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height = "7*" /><RowDefinition Height =  "2*" /><RowDefinition Height =  "*" />
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Column = "0" Margin = "5" FontSize = "14" TextAlignment = "Right" >$List
                    </TextBlock>
                    <Grid Grid.Row="1">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" /><RowDefinition Height="*" /><RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        <RadioButton Name =  "Forest" Content =  "Install Forest" Grid.Row = "0" HorizontalAlignment = "Center" VerticalAlignment = "Center"/>
                        <RadioButton Name =  "Domain" Content =  "Install Domain" Grid.Row = "1" HorizontalAlignment = "Center" VerticalAlignment = "Center"/>
                        <RadioButton Name = "Control" Content = "Install Control" Grid.Row = "2" HorizontalAlignment = "Center" VerticalAlignment = "Center"/>
                    </Grid>
                    <Button          Name =      "Ok" Content =           "Start" Grid.Row = "2" HorizontalAlignment =  "Right" Margin = "10" Width = "60" Height = "20" />
                    <Button          Name =  "Cancel" Content =          "Cancel" Grid.Row = "2" HorizontalAlignment =   "Left" Margin = "10" Width = "60" Height = "20" />
                </Grid>
            </GroupBox>
            <Grid Grid.Column = "1" >
                <Grid.RowDefinitions>
                    <RowDefinition Height = "2*" /><RowDefinition Height = "*" /><RowDefinition Height = "*" /><RowDefinition Height = "*" />
                </Grid.RowDefinitions>
                <GroupBox Grid.Row = "0" Header = "Options" Margin = "10" >
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width = "*"  /><ColumnDefinition Width = "2*" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height = "*" /><RowDefinition Height = "*" /><RowDefinition Height = "*" /><RowDefinition Height = "*" />
                        </Grid.RowDefinitions>
                        $T0
                        $T1
                        <Grid Grid.Row="2" Grid.Column="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="3*" /><ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column = "0"                          HorizontalAlignment = "Center" VerticalAlignment = "Center" >Install DNS Server</TextBlock>
                            <CheckBox  Grid.Column = "1" Name =      "InstallDNS" HorizontalAlignment = "Center" VerticalAlignment = "Center"  />
                        </Grid>
                        <Grid Grid.Row="3" Grid.Column="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="3*" /><ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column = "0"                          HorizontalAlignment = "Center" VerticalAlignment = "Center" >Global Catalogue</TextBlock>
                            <CheckBox  Grid.Column = "1" Name = "GlobalCatalogue" HorizontalAlignment = "Center" VerticalAlignment = "Center" />
                        </Grid>
                        <Grid Grid.Row = "0" Grid.RowSpan = "4" Grid.Column = "1" >
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width = "*" /><ColumnDefinition Width = "3*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height = "*" /><RowDefinition Height = "*" /><RowDefinition Height = "*" /><RowDefinition Height = "*" />
                            </Grid.RowDefinitions>
                            <Label   Content = "Database" Grid.Row = "0" Grid.Column = "0" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" />
                            <TextBox    Name = "Database" Grid.Row = "0" Grid.Column = "1" Height = "20" Margin = "10" >C:\Windows\NTDS</TextBox>
                            <Label   Content =   "Sysvol" Grid.Row = "1" Grid.Column = "0" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" />
                            <TextBox    Name =   "Sysvol" Grid.Row = "1" Grid.Column = "1" Height = "20" Margin = "10" >C:\Windows\SYSVOL</TextBox>
                            <Label   Content =      "Log" Grid.Row = "2" Grid.Column = "0" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" />
                            <TextBox    Name =      "Log" Grid.Row = "2" Grid.Column = "1" Height = "20" Margin = "10" >C:\Windows\SYSVOL</TextBox>
                            <Label   Content = "SiteName" Grid.Row = "3" Grid.Column = "0" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" />
                            <TextBox    Name = "SiteName" Grid.Row = "3" Grid.Column = "1" Height = "20" Margin = "10" >C:\Windows\SYSVOL</TextBox>
                        </Grid>
                    </Grid>
                </GroupBox>
                <GroupBox Grid.Row ="1" Header = "Network Information" Margin = "10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width = "*" /><ColumnDefinition Width = "2.5*" /><ColumnDefinition Width = "*" /><ColumnDefinition Width = "2.5*" />
                        </Grid.ColumnDefinitions>
                        <Label   Content =    "FQDN" Grid.Column = "0" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" />
                        <TextBox    Name =    "FQDN" Grid.Column = "1" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" Height = "20" />
                        <Label   Content = "NetBIOS" Grid.Column = "2" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" />
                        <TextBox    Name = "NetBIOS" Grid.Column = "3" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" Height = "20" />
                    </Grid>
                </GroupBox>
                <GroupBox Grid.Row = "2" Header = "Safe Mode Password" Margin = "10" >
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width = "*" /><ColumnDefinition Width = "2.5*" /><ColumnDefinition Width = "*" /><ColumnDefinition Width = "2.5*" />
                        </Grid.ColumnDefinitions>
                        <Label       Content = "Password" Grid.Column = "0" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" />
                        <PasswordBox    Name =  "DSRM_PW" Grid.Column = "1" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" Height = "20" PasswordChar = "*" />
                        <Label       Content =  "Confirm" Grid.Column = "2" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" />
                        <PasswordBox    Name =  "DSRM_CF" Grid.Column = "3" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" Height = "20" PasswordChar = "*" />
                    </Grid>
                </GroupBox>
                <GroupBox Grid.Row = "3" Header= "Service Account Credential" Margin= "10" >
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width = "*" /><ColumnDefinition Width = "2.5*" /><ColumnDefinition Width = "*" />
                        </Grid.ColumnDefinitions>
                        <Label                   Content = "Account" Grid.Column = "0" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center"/>
                        <TextBox Name = "DCUser"                     Grid.Column = "1" Height = "20" Margin = "5" ></TextBox>
                        <Button  Name = "SVC"    Content = "Update"  Grid.Column = "2" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" Margin= "10" Width = "60" Height = "20"/>
                    </Grid>
                </GroupBox>
            </Grid>
        </Grid>
    </GroupBox>
</Window>
"@.Replace( "'" , '"' )

        $NamedElements = "Forest" , "Domain" , "Control" , "ForestMode" , "DomainMode" , "InstallDNS" , "GlobalCatalogue" , 
        "Database" , "Sysvol" , "Log" , "SiteName" , "FQDN" , "NetBIOS" , "DSRM_PW" , "DSRM_CF" , "DCUser" , "SVC" , "Password" , "Confirm" , "Ok" , "Cancel"

        $GUI = Convert-XAMLtoWindow -Xaml $Xaml -NE $NamedElements -PassThru
        $GUI.Cancel.Add_Click({ $GUI.DialogResult = $False })
        $GUI.Ok.Add_Click({ 

        })
            
            $GUI.FQDN.Text      = ( Get-NetworkInfo     -DNS | % { If ( $_    -ne  $Null ) { $_      } Else { "" } } )
            $GUI.NetBIOS.Text   = ( Get-NetworkInfo -NetBIOS | % { If ( $_.ID -eq "<1C>" ) { $_.Name } Else { "<Not Detected>" } } )

            $GUI.NetBIOS.Text   = ( Get-NetworkInfo -NetBIOS | % { If ( $_.ID -eq "<1B>" ) { $_.Name } Else { "<Not Detected>" } } )

            $GUI.Database.Text = "C:\Windows\NTDS"
            $GUI.Sysvol.Text   = "C:\Windows\SYSVOL"
            $GUI.Log.Text      = "C:\Windows\SYSVOL"
            $GUI.SiteName.Text = "C:\Windows\SYSVOL"
            $Null              = $GUI.Password.Focus()
        
        $OP = Show-WPFWindow -GUI $GUI
    
        If ( $OP -eq $True )
        { 
            $Services = @( Get-FeatureList    )
            $GWF      = @( Get-WindowsFeature )
                
            ForEach ( $i in $Services )
            {
                $GWF | % { 
        
                    If ( ( $_.Name -eq $i ) -and ( $_.InstallState -ne "Installed" ) )
                    {
                        Wrap-Action "Installing" "[~] $i"    
                        Install-WindowsFeature -Name $i -IncludeManagementTools
                    }
                }
            }

            Wrap-Action "Complete" "[+] Roles have been installed"

            $ADDS = [ Ordered ]@{  SafeModeAdministratorPassword = $GUI.Password.SecurePassword
                                             CreateDnsDelegation = $False
                                                    DatabasePath = "C:\Windows\NTDS"
                                                      DomainMode = 7
                                                      DomainName = $GUI.DomainName.Text
                                               DomainNetBIOSName = $GUI.NetBIOS.Text
                                                      ForestMode = 7
                                                      InstallDns = $True
                                                         LogPath = "C:\Windows\NTDS"
                                            NoRebootOnCompletion = $False
                                                      SysvolPath = "C:\Windows\SYSVOL"
                                                           Force = $True }

            IPMO ADDSDeployment

            Install-ADDSForest @ADDS -EA 0

            If ( $? -eq $True ) 
            { 
                Wrap-Action "Successful" "[+] Server has installed the required services, Rebooting"
            }
            
            Else 
            {

                $Cred = New-Object System.Management.Automation.PSCredential -Args "$( $GUI.NetBIOS.Text )\Administrator" , $GUI.Password.SecurePassword

                $ADDSC = [ Ordered ]@{          NoGlobalCatalog = $False 
                                            CreateDnsDelegation = $False 
                                        CriticalReplicationOnly = $False 
                                                   DatabasePath = “C:\Windows\NTDS”
                                                     DomainName = $GUI.DomainName.Text 
                                                     InstallDns = $True 
                                                        LogPath = “C:\Windows\NTDS” 
                                           NoRebootOnCompletion = $False
                                                       SiteName = $GUI.NetBIOS.Text
                                                     SysvolPath = “C:\Windows\SYSVOL” 
                                                          Force = $True 
                                                     Credential = $Cred }

                Install-ADDSDomainController @ADDSC

            }
        }

        Else { Wrap-Action "Exception" "[!] The user cancelled or the dialogue failed" ; Read-Host "Press Enter to Exit" ; Exit }
    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____ 
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//
    Function Determine-Process                                                   #¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯ 
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯   
        
        $CS , $OS = "Computer" , "Operating" | % { GCIM Win32_$( $_ )System }
    
        If ( $CS.PartOfDomain -eq $True ) { Write-Echo -Action "Domain" "[+] Detected" -F 14 ; IPMO ActiveDirectory -VB }

        Else 
        {
            Write-Echo -Function "Workgroup [~] Detected" -F 14
            "Windows" | % { IEX "( [ $_`Principal ][ $_`Identity ]::GetCurrent() ).IsInRole( 'Administrator' )" } | ? {
            $False    | ? { [ Int ] ( GCIM Win32_OperatingSystem ).BuildNumber -ge 6000 }
            $True     | % { $MyInvocation | % { SAPS PowerShell -Verb Runas -Args "-File `"$( $_.MyCommand.Path ) $( $_.UnboundArguments )" ; Exit } } }
        }
        
        Switch( $Host.UI.PromptForChoice( "Promote to Domain Controller?" , "Program has detected this machine is not connected to a domain" ,
        [ Host.ChoiceDescription [] ]@( '&Promote' , '&Bypass' ) , [ Int ] 0 ) )
            {
                0 { Write-Echo -Action "Provisioning" "Domain Controller" -F 11
                    Provision-DomainController
                
                  } 
                
                1 { 
                
                } 
                
            }
        }
    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____  
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
        Write-Echo -Foot -F 10 -B 0 ; Sleep 1 # What Free Actually Means         #¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
     #\______________________________________________________________________________//¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯      
     #¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯                                                                   
