# ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\   ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯   //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//  [ Secure Digits Plus LLC | Hybrid | Desired State Controller ]  \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯     ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯     ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯                 Dynamically Engineered Digital Security                    ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\                    ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯                       //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//   Application Development | Virtualization | Network and Hardware Magistration   \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯   //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//   https://www.securedigitsplus.com | Server-Client | Seedling-Spawning Script    \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\___¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ ___//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\   [ Provisional Author : Michael C Cook Sr. | "The Buck Stops Here" ]    //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//   ____    ____    ____    ____    ____    ____    ____    ____    ____   \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯  
#\\  [ Provision-DomainController ] @: Orchestrates the process of provisioning server prerequisites in order to install Hybrid-DSC 
#//   ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____      
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\___  
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
# ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯  
    
    Using Namespace System.Security.Principal
    Using Namespace System.Management.Automation
    Using Namespace System.DirectoryServices
    
    $ENV:PSModulePath.Split( ';' ) | % { GCI $_ -Recurse "Hybrid-DSC.psm1" } | % { 
        
        IPMO $_.FullName
        
        If ( $? -ne $True ) { Write-Error "Module Not Loaded/Found" }
        
        Sleep 1

    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____                                                                           ____    ____    ____    ____    ____    ____    ____    ____    ____  
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
    Function Get-FeatureList # Collects all server features that pertain to DSC   ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯ 
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯      
        
        Return @( @( "AD-Domain-Services" , "DHCP" , "DNS" , "GPMC" ) ; @( "" ; @( "-AdminCenter" , "-PowerShell" , "-Tools" | % { "-AD$_" } ) + 
        @( "" , "-Tools" | % { "-ADDS$_" } ) + "-DHCP" , "-DNS-Server" , "-Role-Tools" ) | % { "RSAT$_" } ;
        @( "" , "-Deployment" , "-Transport" , "-AdminPack" | % { "WDS$_" } ) )

    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____ 
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
    Function Collect-FeaturesState # Determines Installation Loadout              ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯ 
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯      

        [ CmdLetBinding () ] Param ( [ Parameter () ][ Switch ] $All )

        $Services = Get-FeatureList ; $GWF = Get-WindowsFeature ; $Array = @( ) ; $Table = [ Ordered ]@{ Installed = @( ) ; Available = @( ) }

        ForEach ( $I in $Services ) { $X = $GWF | ? { $_.Name -eq $I } | % { 
            If ( $_.InstallState -ne "Installed" ) { $Array += "$I [_]" ; $Table.Available += "$I [_]" }
            If ( $_.InstallState -eq "Installed" ) { $Array += "$I [X]" ; $Table.Installed += "$I [X]" } } }

        Return $( If ( !$All ) { $Table } If (  $All ) { $Array } )

    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____ 
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
    Function Enter-ServiceAccount # Allows entry / use of an AD service account   ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯   

        [ CmdLetBinding () ] Param (

            [ Parameter ( Position = 0 , ValueFromPipeline = $True ) ] [ String ] $DC      ,
            [ Parameter ( Position = 1 , ValueFromPipeline = $True ) ] [ String ] $Domain  ,
            [ Parameter ( Position = 2 , ValueFromPipeline = $True ) ] [ String ] $NetBIOS )

        $XAML = @"
<Window                               xmlns =                 "http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                                    xmlns:x =                              "http://schemas.microsoft.com/winfx/2006/xaml" 
                                      Title =                         "Secure Digits Plus LLC | Hybrid-DSC Service Login" 
                                      Width =                                                                       "350" 
                                     Height =                                                                       "250" 
                                 ResizeMode =                                                                  "NoResize" 
                      WindowStartupLocation =                                                              "CenterScreen" 
                                    Topmost =                                                                      "True" >
    <GroupBox 
                                     Header =                           "Enter Directory Services Administration Account" 
                                      Width =                                                                       "330" 
                                     Height =                                                                       "220" 
                          VerticalAlignment =                                                                       "Top">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height = "2*" />
                <RowDefinition Height =  "1.25*" />
            </Grid.RowDefinitions>
            <Grid Grid.Row = "0" >
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width =    "*" />
                    <ColumnDefinition Width = "2.5*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition   Height = "*" />
                    <RowDefinition   Height = "*" />
                    <RowDefinition   Height = "*" />
                </Grid.RowDefinitions>
                <TextBlock                     Grid.Column = "0" Grid.Row = "0" Margin = "10" TextAlignment = "Right" >Username:</TextBlock>
                <TextBox     Name = "Username" Grid.Column = "1" Grid.Row = "0" Height = "24" Margin = "5" ></TextBox>
                <TextBlock                     Grid.Column = "0" Grid.Row = "1" Margin = "10" TextAlignment = "Right" >Password:</TextBlock>
                <PasswordBox Name = "Password" Grid.Column = "1" Grid.Row = "1" Height = "24" Margin = "5" PasswordChar = "*" ></PasswordBox>
                <TextBlock                     Grid.Column = "0" Grid.Row = "2" Margin = "10" TextAlignment = "Right" >Confirm:</TextBlock>
                <PasswordBox Name =  "Confirm" Grid.Column = "1" Grid.Row = "2" Height = "24" Margin = "5" PasswordChar = "*" ></PasswordBox>
            </Grid>
            <Grid Grid.Row = "1" >
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width = "*" />
                    <ColumnDefinition Width = "*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <RadioButton Name = "Port_Toggle" Grid.Row = "0" Grid.Column = "0" Content = "Alternate Port / SSL" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                <TextBox     Name =  "Port_Entry" Grid.Row = "0" Grid.Column = "1" HorizontalAlignment="Center" VerticalAlignment="Center" Width="120" IsEnabled="False">389</TextBox>
                <Button      Name =          "Ok" Content =     "Ok" Grid.Column = "0" Grid.Row = "1" Margin = "5" ></Button>
                <Button      Name =      "Cancel" Content = "Cancel" Grid.Column = "1" Grid.Row = "1" Margin = "5" ></Button>
            </Grid>
        </Grid>
    </GroupBox>
</Window>
"@
        $NamedElements = "Username" , "Password" , "Confirm" , "Port_Toggle" , "Port_Entry" , "Ok" , "Cancel"

        $0 = "Username" , "Password" , "Confirmation" ; $1 = $0 | % { "You must enter a $_" } ; $2 = $0 | % { "$_ Error" }
        $1[2] = $1[2].Replace( "You must enter a" , "Password Must Match the" ) 
        $1   += "Invalid information. All fields must be correct and valid." ; $2 += "Authentication Failure"

        $MSG  = 0..3 | % { "[ System.Windows.MessageBox ]::Show( '$( $1[$_] )' , '$( $2[$_] )' )" }

        $GUI = Convert-XAMLtoWindow -Xaml $Xaml -NE $NamedElements -PassThru

        $GUI.Port_Toggle.Add_Click({ $GUI.Port_Entry.IsEnabled = $True })
        $GUI.Cancel.Add_Click({ $GUI.DialogResult = $False })
        $GUI.Ok.Add_Click({

            $Port = $( If ( $GUI.Port_Entry.IsEnabled -eq $True ) { $GUI.Port_Entry.Text } Else { 389 } )
            $Cred = [ PSCredential ]::New( $GUI.Username.Text , $GUI.Password.SecurePassword )
            $AD   = "LDAP://$( $DC ):$Port/DC=$( $Domain.Split('.') -join ',DC=' )"
            $DX   = [ DirectoryEntry ]::New( "$AD" , $Cred.Username , $Cred.GetNetworkCredential().Password )

            If     ( $GUI.Username.Text     -eq       $Null )                 { IEX $MSG[0] }
            ElseIf ( $GUI.Password.Password -eq       $Null )                 { IEX $MSG[1] }
            ElseIf (  $GUI.Confirm.Password -eq       $Null )                 { IEX $MSG[2] } 
            ElseIf ( $GUI.Password.Password -notmatch $GUI.Confirm.Password ) { IEX $MSG[2] }
            ElseIf ( $DX.Name -eq $Null )                                     { IEX $MSG[3] }

            Else { $GUI.DialogResult = $True }
        })

        $Null = $GUI.Username.Focus()

        $OP = Show-WPFWindow -GUI $GUI
        
        If ( $OP -eq $True ) { Return [ PSCredential ]::New( $GUI.Username.Text , $GUI.Password.SecurePassword ) }

        Else { Write-Echo -Action "Exception" "Either the user cancelled, or the dialogue failed" -F 12 }

    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____  
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//
    Function Provision-DomainController                                          #¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯   

        [ CmdLetBinding () ] Param (

            [ Parameter ( Position = 0 , ValueFromPipeline = $True ) ] [ String       ]       $DC ,
            [ Parameter ( Position = 1 , ValueFromPipeline = $True ) ] [ String       ]   $Domain ,
            [ Parameter ( Position = 2 , ValueFromPipeline = $True ) ] [ String       ]  $NetBIOS ,
            [ Parameter ( Position = 3 , ValueFromPipeline = $True ) ] [ PSCredential ]   $DCCred ,
            [ Parameter ( Position = 4 , ValueFromPipeline = $True ) ] [ String       ] $SiteLink )

        $CS = ( GCIM Win32_OperatingSystem ).Caption
        
        If ( $DC -and $Domain -and $DCCred )
        {
            Write-Echo -Function "Domain Controller detected" 14 0
            Write-Echo -Action "Attempting Access" "[ $( $DCCred.Username ) ]" 10 0
            $DCCred | % { $DX = [ DirectoryEntry ]::New( "LDAP://$( $DC ):389/RootDSE" , $_.Username , $_.GetNetworkCredential().Password ) }
            If ( $DX.IsGlobalCatalogReady -eq "TRUE" ) { $GC = 0 ; $Forest = 0 }
        }

        $Schema = "http://schemas.microsoft.com/winfx/2006/xaml"
        $Author = "Secure Digits Plus LLC"
        $Select = "IsSelected = 'True"
        $Enable = "IsEnabled = 'False"

        $ED     = @( ) 
        $On     = 1

        "2003" , "2008" , "2008 R2" , "2012" , "2012 R2" , "2016"  | % {

            If ( $On -eq 0 ) { $ED += "Server $_" }
            If ( $On -eq 1 )
            {   
                If ( $_    -like "*R2*" ) 
                { 
                    If ( $CS -like "*$_*" ) 
                    { 
                        $ED += "Server $_' $Select" 
                    } 
                    
                    Else 
                    { 
                        $ED += "Server $_' $Enable" 
                    }
                }

                If ( $_ -notlike "*R2*" ) 
                { 
                    If ( ( $CS -like "*$_*" ) -and ( $CS -notlike "*R2*" ) ) 
                    { 
                        $ED += "Server $_' $Select" 
                    } 
                    
                    Else 
                    { 
                        $ED += "Server $_' $Enable" 
                    } 
                }

                If ( ( $ED | ? { $_ -like "*IsSelected*" } ) -ne $Null ) { $On = 0 } 
            }
        }

        $Default = $( If ( ( $ED | ? { $_ -like "*IsSelected*" } ) -eq $Null ) { "( Default )' $Select" } Else { "( Default )' $Enable" } )

        $List = @( Collect-FeaturesState -All ) | % { "$_<LineBreak/>" } 
        
        $ID = ( "ForestMode" , 0 , 0 ) , ( "DomainMode" , 1 , 0 ) 
        $YZ = $ID | % { "    <ComboBox Name = '$( $_[0] )' Grid.Row = '$( $_[1] )' Grid.Column = '$( $_[2] )' Height = '24' >" }

        ForEach ( $x in 0..1 ) 
        {   
            $Items = @( $YZ[$X] , "$( $ID[$X][0] ) $Default" ; @( $ED | % { "$_" } ) ) 
            $Y     = @( ) 

            0..8 | % {  

                If ( $_ -eq    0 ) { $Y += "$( $Items[$_] )
                " }   
                  
                If ( $_ -in 1..7 ) { $Y += "                       <ComboBoxItem Content = '$( $Items[$_] )' ></ComboBoxItem>
                " }

                If ( $_ -eq    8 ) { $Y += "                   </ComboBox>" } 
            }
            
            If ( $X -eq 0 ) { $T0 = $Y } If ( $X -eq 1 ) { $T1 = $Y } ; $Y = $Null }

        $Center = "VerticalContentAlignment = 'Center' HorizontalContentAlignment = 'Center'"

        $Xaml = @"
<Window                                           
                                                  xmlns = "http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                                                xmlns:x = "http://schemas.microsoft.com/winfx/2006/xaml" 
                                                  Title = "Secure Digits Plus LLC | Hybrid - Desired State Controller Installation" 
                                                  Width = "800" 
                                                 Height = "800" 
                                    HorizontalAlignment = "Center" 
                                  WindowStartupLocation = "CenterScreen" 
                                                Topmost = "True" >
    <Window.Resources>
        <Style TargetType = "{x:Type ToolTip}" >
            <Setter Property = "Background" Value = "White" />
        </Style>
    </Window.Resources>
    <GroupBox                                  
                                                 Header = "[ Hybrid-DSC Initial Service Configuration ]" 
                                    HorizontalAlignment = "Center" 
                                      VerticalAlignment = "Center" 
                                                  Width = "760" 
                                                 Height = "740" 
                                                 Margin = "10" >
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width =  "*" />
                <ColumnDefinition Width = "2.5*" />
            </Grid.ColumnDefinitions>
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height =     "3*" />
                    <RowDefinition Height =      "*" />
                    <RowDefinition Height =      "*" />
                    <RowDefinition Height =  "0.75*" />
                </Grid.RowDefinitions>
                <GroupBox Grid.Row = "0" Header = "Feature List" Margin = "10" >
                    <TextBlock FontSize = "14" TextAlignment = "Right" >$List
                    </TextBlock>
                </GroupBox>
                <GroupBox Grid.Row = "1" Header = "Controller Installation Type" Margin = "10" >
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height = "*" />
                            <RowDefinition Height = "*" />
                            <RowDefinition Height = "*" />
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width = "5*" />
                            <ColumnDefinition Width =  "*" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Row = "0" TextAlignment = "Right" Margin = "5" >Create a New AD Forest:</TextBlock>
                        <TextBlock Grid.Row = "1" TextAlignment = "Right" Margin = "5" >Add a Branch Domain:</TextBlock>
                        <TextBlock Grid.Row = "2" TextAlignment = "Right" Margin = "5" >Add Domain Controller:</TextBlock>
                        <RadioButton Name = "New_Forest" GroupName = "Process" Grid.Row = "0" Grid.Column = "1" Margin = "5" />
                        <RadioButton Name = "New_Domain" GroupName = "Process" Grid.Row = "1" Grid.Column = "1" Margin = "5" />
                        <RadioButton Name = "New_DCHost" GroupName = "Process" Grid.Row = "2" Grid.Column = "1" Margin = "5" />
                    </Grid>
                </GroupBox>
                <GroupBox Grid.Row = "2" Header = "Additional Controller Features" Margin = "10" >
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height = "*" />
                            <RowDefinition Height = "*" />
                            <RowDefinition Height = "*" />
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width = "5*" />
                            <ColumnDefinition Width =  "*" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Row = "0" TextAlignment = "Right" Margin = "5" >Install DNS Server:</TextBlock>
                        <TextBlock Grid.Row = "1" TextAlignment = "Right" Margin = "5" >Global Catalog:</TextBlock>
                        <TextBlock Grid.Row = "2" TextAlignment = "Right" Margin = "5" >Critical Replication:</TextBlock>
                        <CheckBox Name = "Install_DNS" Grid.Row = "0" Grid.Column = "1" Margin = "5" />
                        <CheckBox Name =  "Install_GC" Grid.Row = "1" Grid.Column = "1" Margin = "5" />
                        <CheckBox Name =  "Install_CR" Grid.Row = "2" Grid.Column = "1" Margin = "5" />
                    </Grid>
                </GroupBox>
                <GroupBox Grid.Row = "3" Header = "Initialize / Cancel" Margin = "10" >
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width = "*" />
                            <ColumnDefinition Width = "*" />
                        </Grid.ColumnDefinitions>
                        <Button Name =  "Cancel" Content = "Cancel" Margin = "10" Grid.Column = "0" />
                        <Button Name =      "Ok" Content =  "Start" Margin = "10" Grid.Column = "1" />
                    </Grid>
                </GroupBox>
            </Grid>
            <Grid Grid.Column = "1" >
                <Grid.RowDefinitions>
                    <RowDefinition Height = "2*" />
                    <RowDefinition Height =  "*" />
                    <RowDefinition Height =  "*" />
                    <RowDefinition Height =  "*" />
                </Grid.RowDefinitions>
                <GroupBox Grid.Row = "0" Header = "Options" Margin = "10" >
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width =  "*" />
                            <ColumnDefinition Width = "2*" />
                        </Grid.ColumnDefinitions>
                        <Grid Grid.Column = "0" >
                            <Grid.RowDefinitions>
                                <RowDefinition Height = "*"/>
                                <RowDefinition Height = "*"/>
                            </Grid.RowDefinitions>
                            $T0
                            $T1
                        </Grid>
                        <Grid Grid.Column = "1" >
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width =  "*" />
                                <ColumnDefinition Width = "3*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height = "*" />
                                <RowDefinition Height = "*" />
                                <RowDefinition Height = "*" />
                                <RowDefinition Height = "*" />
                            </Grid.RowDefinitions>
                            <Label   Content = "Database" Grid.Row = "0" Grid.Column = "0" HorizontalAlignment = "Center" VerticalAlignment = "Center" />
                            <TextBox    Name = "Database" Grid.Row = "0" Grid.Column = "1" Height = "20" Margin = "10" ></TextBox>
                            <Label   Content =   "Sysvol" Grid.Row = "1" Grid.Column = "0" HorizontalAlignment = "Center" VerticalAlignment = "Center" />
                            <TextBox    Name =   "Sysvol" Grid.Row = "1" Grid.Column = "1" Height = "20" Margin = "10" ></TextBox>
                            <Label   Content =      "Log" Grid.Row = "2" Grid.Column = "0" HorizontalAlignment = "Center" VerticalAlignment = "Center" />
                            <TextBox    Name =      "Log" Grid.Row = "2" Grid.Column = "1" Height = "20" Margin = "10" ></TextBox>
                            <Label   Content = "SiteName" Grid.Row = "3" Grid.Column = "0" HorizontalAlignment = "Center" VerticalAlignment = "Center" />
                            <TextBox    Name = "SiteName" Grid.Row = "3" Grid.Column = "1" Height = "20" Margin = "10" >$Sitelink</TextBox>
                        </Grid>
                    </Grid>
                </GroupBox>
                <GroupBox Grid.Row ="1" Header = "Network Information" Margin = "10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width =    "*" />
                            <ColumnDefinition Width = "2.5*" />
                            <ColumnDefinition Width =    "*" />
                            <ColumnDefinition Width = "2.5*" />
                        </Grid.ColumnDefinitions>
                        <Label   Content =    "FQDN" Grid.Column = "0" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" />
                        <TextBox    Name =    "FQDN" Grid.Column = "1" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" Height = "20" >$Domain</TextBox>
                        <Label   Content = "NetBIOS" Grid.Column = "2" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" />
                        <TextBox    Name = "NetBIOS" Grid.Column = "3" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" Height = "20" >$NetBIOS</TextBox>
                    </Grid>
                </GroupBox>
                <GroupBox Grid.Row = "2" Header = "Safe Mode Password" Margin = "10" >
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width =    "*" />
                            <ColumnDefinition Width = "2.5*" />
                            <ColumnDefinition Width =    "*" />
                            <ColumnDefinition Width = "2.5*" />
                        </Grid.ColumnDefinitions>
                        <Label       Content = "Password" Grid.Column = "0" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" />
                        <PasswordBox    Name =  "DSRM_PW" Grid.Column = "1" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" Height = "20" PasswordChar = "*" />
                        <Label       Content =  "Confirm" Grid.Column = "2" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" />
                        <PasswordBox    Name =  "DSRM_CF" Grid.Column = "3" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" Height = "20" PasswordChar = "*" />
                    </Grid>
                </GroupBox>
                <GroupBox Grid.Row = "3" Header= "Service Account Credential" Margin= "10" >
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width =    "*" />
                            <ColumnDefinition Width = "2.5*" />
                            <ColumnDefinition Width =    "*" />
                        </Grid.ColumnDefinitions>
                        <Label                    Content = "Account" Grid.Column = "0" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center"/>
                        <TextBox Name = "DCAdmin"                     Grid.Column = "1" Height = "20" Margin = "5" >$( $DCCred.Username )</TextBox>
                        <Button  Name = "DCEntry" Content = "Update"  Grid.Column = "2" VerticalContentAlignment = "Center" HorizontalContentAlignment = "Center" Margin= "10" Width = "60" Height = "20" />
                    </Grid>
                </GroupBox>
            </Grid>
        </Grid>
    </GroupBox>
</Window>
"@.Replace( "'" , '"' )

        $NamedElements = "New_Forest" , "New_Domain" , "New_DCHost" , "Install_DNS" , "Install_GC" , "Install_CR" , "ForestMode" , "DomainMode" , 
        "Database" , "Sysvol" , "Log" , "SiteName" , "FQDN" , "NetBIOS" , "DSRM_PW" , "DSRM_CF" , "DCAdmin" , "DCEntry" , "Ok" , "Cancel"

        $GUI = Convert-XAMLtoWindow -Xaml $Xaml -NE $NamedElements -PassThru

        $Out = [ PSCustomObject ]@{ Forest = "" ; GC = "" ; Domain = "" ; DCHost = "" ; }

        #¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯#
        #___[_Install-ADDSForest_]___Auto Enable/Disable Flags____________________________________________________________________#

            If ( $Forest -eq 0 )       { $GUI.New_Forest.IsEnabled({ $False          }) }
            Else                       { $GUI.New_Forest.Add_Click({ $Out.Forest = 1 }) }

        #¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯#
        #___[_Global_Catalog_=_0_]___Auto Enable/Disable Flags____________________________________________________________________#

            If ( $GC     -eq 0 )       { $GUI.Install_GC.IsEnabled({ $False          }) }
            Else { $GUI.Install_GC | % { $_.IsUnchecked({   $Out.GC = 0 }) ; $_.IsEnabled({     $False      }) }
        
        #¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯#
        #___[_GUI_Flags/Options_]_________________________________________________________________________________________________#

            $GUI.New_Domain.Add_Click({  $Out.Domain = 1 })
            $GUI.New_DCHost.Add_Click({  $Out.DCHost = 1 })

            $GUI.Install_DNS | % { $_.Add_Checked({ $Out.DNS  = 1 }) ; $_.Add_UnChecked({ $Out.DNS = 0 }) }
            $GUI.Install_CR  | % { $_.Add_Checked({ $Out.CR   = 1 }) ; $_.Add_UnChecked({ $Out.CR  = 0 }) }

            $GUI.DCEntry.Add_Click({ $DCCred = @( Enter-ServiceAccount @ServiceAccount ) })
            $GUI.Cancel.Add_Click({  $GUI.DialogResult = $False })

            $GUI.Ok.Add_Click({
        
        #¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯#
        #___[_Domain_Functional_Levels_]__________________________________________________________________________________________#

            $GUI.ForestMode | ? { $Out.ForestMode = ( $_.SelectedIndex + 1 ) }
            $GUI.DomainMode | ? { $Out.DomainMode = ( $_.SelectedIndex + 1 ) }

        #¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯#
        #___[_Domain_Functional_Levels_]__________________________________________________________________________________________#

            $0 = @( "Password" , "Confirmation" , "P/W Confirm" | % { "$_ Error" } ; "Controller Installation Type was not selected." )
            $1 = @( "Null" , "Null" , "Match" | % { "Invalid/$_" } ; "A controller type must be selected" )

            $MSG = 0..3 | % { "[ System.Windows.MessageBox ]::Show( '$( $0[$_] )' , '$( $1[$_] )' )" }

            If ( $GUI.DSRM_PW.Password -eq $Null )                       { IEX $MSG[0] }
            If ( $GUI.DSRM_CF.Password -eq $Null )                       { IEX $MSG[1] }
            If ( $GUI.DSRM_PW.Password -notmatch $GUI.DSRM_CF.Password ) { IEX $MSG[2] }
            If ( $Out.Forest -and $Out.Domain -and $Out.DCHost -eq 0 )   { IEX $MSG[3] }

            Else { $GUI.DialogResult = $True }

        })

            $GUI.Database.Text = "C:\Windows\NTDS"
            $GUI.Sysvol.Text   = "C:\Windows\SYSVOL"
            $GUI.Log.Text      = "C:\Windows\SYSVOL"
            $GUI.Sitelink      = If ( $SiteLink -ne $Null ) { $SiteLink } Else { "Default-First-Site-Name" }

        $Null = $GUI.Username.Focus()

        $OP = Show-WPFWindow -GUI $GUI
        
        If ( $OP -eq $True ) 
        { 
            Echo $Out
            Read-Host "Correct?"
            #Write-Theme -Function "You're awesome Michael." 10 12 15 0
        }

        Else { Write-Theme -Action "[!] Exception" "Either the user cancelled, or the dialogue failed" 12 14 12 }
        
    }

        Function DeadForNow
        {
            $Services = @( Get-FeatureList    )
            $GWF      = @( Get-WindowsFeature )
                
            ForEach ( $i in $Services )
            {
                $GWF | % { 
        
                    If ( ( $_.Name -eq $i ) -and ( $_.InstallState -ne "Installed" ) )
                    {
                        Wrap-Action "Installing" "[~] $i"    
                        Install-WindowsFeature -Name $i -IncludeManagementTools
                    }
                }
            }

            Wrap-Action "Complete" "[+] Roles have been installed"

            $ADDS = [ Ordered ]@{  SafeModeAdministratorPassword = $GUI.Password.SecurePassword
                                             CreateDnsDelegation = $False
                                                    DatabasePath = "C:\Windows\NTDS"
                                                      DomainMode = 7
                                                      DomainName = $GUI.DomainName.Text
                                               DomainNetBIOSName = $GUI.NetBIOS.Text
                                                      ForestMode = 7
                                                      InstallDns = $True
                                                         LogPath = "C:\Windows\NTDS"
                                            NoRebootOnCompletion = $False
                                                      SysvolPath = "C:\Windows\SYSVOL"
                                                           Force = $True }

            IPMO ADDSDeployment

            Install-ADDSForest @ADDS -EA 0

            If ( $? -eq $True ) 
            { 
                Wrap-Action "Successful" "[+] Server has installed the required services, Rebooting"
            }
            
            Else 
            {

                $Cred = New-Object System.Management.Automation.PSCredential -Args "$( $GUI.NetBIOS.Text )\Administrator" , $GUI.Password.SecurePassword

                $ADDSC = [ Ordered ]@{          NoGlobalCatalog = $False 
                                            CreateDnsDelegation = $False 
                                        CriticalReplicationOnly = $False 
                                                   DatabasePath = “C:\Windows\NTDS”
                                                     DomainName = $GUI.DomainName.Text 
                                                     InstallDns = $True 
                                                        LogPath = “C:\Windows\NTDS” 
                                           NoRebootOnCompletion = $False
                                                       SiteName = $GUI.NetBIOS.Text
                                                     SysvolPath = “C:\Windows\SYSVOL” 
                                                          Force = $True 
                                                     Credential = $Cred }

                Install-ADDSDomainController @ADDSC

            }

    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____ 
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//
    Function Determine-Process                                                   #¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯ 
    {#\______________________________________________________________________________/¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯   
        
        $CS , $OS = "Computer" , "Operating" | % { GCIM Win32_$( $_ )System }

        "Must enable DNS Suffix/DHCP Static" , "Don't Forget 'regsvr32 schmmgmt.dll'" | % { Write-Warning $_ } 
        
        If ( $CS.PartOfDomain -eq $True ) 
        {
            Write-Theme -Action "[+] Domain" "Detected" 14 12 10 0
            IPMO ActiveDirectory -VB
            $DCCred = @( Enter-ServiceAccount )
        }

        Else
        {
            Write-Echo -Function "Workgroup [~] Detected" 14 0

            "Windows"   | % { IEX "( [ $_`Principal ][ $_`Identity ]::GetCurrent() ).IsInRole( 'Administrator' )" } | ? {
            $False      | ? { [ Int ] $OS.BuildNumber -ge 6000 }
            $True       | % { $MyInvocation | % { SAPS PowerShell -Verb Runas -Args "-File `"$( $_.MyCommand.Path ) $( $_.UnboundArguments )" } } }

            If ( $? -eq $True )
            {
                Write-Echo -Function "Collecting Network/Host Information [30-45 seconds]" 10 0
                
                $Time   = [ System.Diagnostics.Stopwatch ]::StartNew()

                $Report = @( Start-NetworkInfo )

                $Report | % { $ServiceAccount = @{ DC = $_.NetBIOS.Host ; Domain = $_.DNS ; NetBIOS = $_.NetBIOS.Name } 
                              $DomainController = $ServiceAccount , @{ Sitelink = $Report.SiteLink } }

                $Time.Stop() ; Write-Echo -Function "Network Info Collected @: Time elapsed $( $Time.Elapsed )" 10 0

                If ( $DC -ne $Null -and $Domain -ne $Null -and $NetBIOS -ne $Null ) 
                {
                    $DCCred = @( Enter-ServiceAccount @ServiceAccount )
                    If ( $? -eq $True ) 
                    { 
                        Write-Echo -Action "Provisioning" "Domain Controller Setup" 11 0
                        $DomainController | % { $_.DCCred = $DCCred }
                        Provision-DomainController @DomainController
                    }
                }
            }
        }
    }#                                                                            ____    ____    ____    ____    ____    ____    ____    ____    ____  
#//¯¯\\__________________________________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
        Write-Theme -Foot ; Sleep 1 ; Determine-Process                          #¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
     #\______________________________________________________________________________//¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯      
     #¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯                                                                   
