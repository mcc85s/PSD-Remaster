<#___ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____  
//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\   ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯   //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//  [ Secure Digits Plus LLC | Hybrid | Desired State Controller ]  \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯       _____________________________________________________        ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯        __/¯¯\__[ Dynamically Engineered Digital Security ]__/¯¯\__         ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\  _________________________ ________________ ___________________________________  //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
\\__//¯¯\\__//¯¯\\__//¯¯\\__// | Application Development | Virtualization | Network and Hardware Magistration | \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\  ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯  //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
\\__//¯¯\\__//¯¯\\__//¯¯\\__//   https://www.securedigitsplus.com | Server-Client | Seedling-Spawning Script    \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\___¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ ___//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\   [ Provisional Author : Michael C Cook Sr. | "The Buck Stops Here" ]    //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//   ____    ____    ____    ____    ____    ____    ____    ____    ____   \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
\\__/====\__/----\__/====\__/----\__/====\__/----\__/====\__/----\__/====\__/----\__/====\__/----\__/====\__/----\__/====\__/----\__/====\__/----\__// 
//¯¯¯    
\\  [ Provision-DomainController ] @: Orchestrates the process of provisioning server prerequisites in order to install Hybrid-DSC                     
//   ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____      
\\  /----\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//==\\__/---\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//==\\___  
//  \____________________________________________________________________________________¯¯¯¯ -- ¯¯¯¯ ¯¯ ¯¯¯¯ -- ¯¯¯¯ ¯¯ ¯¯¯¯ -- ¯¯¯¯ ¯¯ ¯¯¯¯ -- ¯¯¯\\ 
\\   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\___ __ ____ -- ____ __ ____ -- ____ __ ____ -- ____ __ ___// 
//                                                                                                               ____    ____    ____    ____    ____ 
\\         Declare Namespaces & Load Modules ( Like a ninja turtle saying 'Cowabunga' and then eating pizza )   //¯¯\\==//¯¯\\--//¯¯\\==//¯¯\\--//¯¯¯  
//         ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    
#>
    
        "Security.Principal" , "Management.Automation" , "DirectoryServices" | % { IEX "Using Namespace System.$_" } # 'Cowabunga'
    
        $ENV:PSModulePath.Split( ';' ) | % { GCI $_ -Recurse "Hybrid-DSC.psm1" } | % {                               # Looking for pizza...
        
        IPMO $_.FullName -Force                                                                                      # Pizza found
        
        If ( $? -ne $True ) 
        { 
            Write-Error "Module Not Loaded/Found"                                                                    # Pizza not found
            Read-Host "Press Enter to Exit"                                                                          # Lame
            Exit                                                                                                     # Bye
        }     
<#                                                                                    ____    ____    ____    ____    ____    ____    ____    ____      
 ____                                                                              __//¯¯\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//¯¯\\___  
//¯¯\\____________________________________________________________________________/¯¯¯    ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯\\ 
\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯        ____    ____ __ ____ __ ____ __ ____ __ ____ __ ____    ___// 
#>  Function Validate-DomainName # Verfies that text entries are valid __________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
    {#/¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯      
        [ CmdLetBinding () ] [ OutputType ( "String" ) ] Param (

            [ Parameter ( Mandatory = $True , ParameterSetName = "0" ) ][ String ] $NetBIOS  ,
            [ Parameter ( Mandatory = $True , ParameterSetName = "1" ) ][ String ] $Domain   ,
            [ Parameter ( Mandatory = $True , ParameterSetName = "2" ) ][ String ] $SiteName )

        $C = "abcdefghijklmnopqrstuvwxyz" , "0123456789" , ".-" , "``~!@#$%^&*()=+_[]{}\|;:'`",<>/? " ; $I = $C -join ''

        $Alpha = $I[ 0..25] ; $Numeric = $I[26..35] + 0..9 ; $Split = $I[36..37] ; $Special = $I[38..68] ; $AN = $I[ 0..35] + 0..9

        $Reserved   = @{ 
            
            Words   = @( "ANONYMOUS,AUTHENTICATED USER,BATCH,BUILTIN,DIALUP,DIGEST AUTH,INTERACTIVE,INTERNET,NT AUTHORITY,NT DOMAIN" ,
                         "NTLM AUTH,NULL,PROXY,REMOTE INTERACTIVE,RESTRICTED,SCHANNEL AUTH,SELF,SERVER,SERVICE,SYSTEM,TERMINAL SERVER"
                         "THIS ORGANIZATION,USERS,WORLD" ; "LOCAL" | % { $_ , "$_ SYSTEM"  } ; "NETWORK" | % { $_ , "$_ SERVICE" } ; 
                         "GROUP" , "OWNER" | % { $_ , "$_ SERVER" } | % { "CREATOR $_" } ) -join ',' | % { $_.Split( ',' ) } | Sort

            DNSHost = "-GATEWAY" , "-GW" , "-TAC" <# RFC 952 #>

            SDDL    = "AN,AO,AU,BA,BG,BO,BU,CA,CD,CG,CO,DA,DC,DD,DG,DU,EA,ED,HI,IU,LA,LG,LS,LW,ME,MU,NO,NS,NU,PA,PO,PS,PU,RC,RD,RE,RO" +
                      "RS,RU,SA,SI,SO,SU,SY,WD" | % { $_.Split( ',' ) }
        }

        If ( $NetBIOS  ) { $X = $NetBIOS  ; $Y = @{ Min = 1 ; Max = 15 ; Reserve = $Reserved.Words ; Allow = $I[0..37] ; Deny = $Special } }
        If ( $Domain   ) { $X = $Domain   ; $Y = @{ Min = 2 ; Max = 63 ; Reserve = $Reserved.Words ; Allow = $I[0..37] ; Deny = $Special } } 
        If ( $SiteName ) { $X = $SiteName ; $Y = @{ Min = 1 ; Max = 63 ; Reserve = $Reserved.Words ; Allow = $I[0..37] ; Deny = $Special } }

        If ( $X.Length -lt $Y.Min )                                          { "Name is too short" }
        ElseIf ( $X.Length -gt $Y.Max )                                      { "Name is too long"  }
        ElseIf ( ( $X[0..$X[-1]] | ? { $_ -in $Y.Deny } ).Count -gt 0 )      { "Name has invalid characters" }

        ElseIf ( $NetBIOS )
        {
            If     ( "." -in $X )                                            { "Period found in NetBIOS Domain Name, breaking" }
            ElseIf ( $X -in $Y.Reserve )                                     { "Name is reserved" }
            Else { Return $X }
        }
            
        ElseIf ( ( $Domain ) -or ( $SiteName ) )
        {
            If ( ( $X[0] -notin $AN ) -and ( $X[-1] -notin $AN ) -eq $True ) { "First/Last Character must be AlphaNumeric" }
                
            ElseIf ( $Domain )
            {
                If ( ( $X.Length -eq 2 ) -and ( $X -in $Reserved.SDDL ) )    { "Name is reserved" }
                Else { Return $X }
            }
            
            ElseIf ( $SiteName )
            {
                Return $X
            }
        }
    }
<#                                                                                    ____    ____    ____    ____    ____    ____    ____    ____      
 ____                                                                              __//¯¯\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//¯¯\\___  
//¯¯\\____________________________________________________________________________/¯¯¯    ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯\\ 
\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯        ____    ____ __ ____ __ ____ __ ____ __ ____ __ ____    ___// 
#>  Function Get-DSCPromoControl # Provides backend for reliable XAML Control ___________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
    {#/¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯      
        Return [ PSCustomObject ]@{ 
        
        Command     = "" ; Process     = "" ; Forest      = "" ; Tree        = "" ; Child       = "" ; Clone       = "" ; 
        
        DomainType  = "" ; ForestMode  = "" ; DomainMode  = "" ; ParentDomainName               = "" ;
        
        AD_Domain_Services             = "" ; DHCP        = "" ; DNS         = "" ; GPMC        = "" ; RSAT        = "" ; 
        RSAT_AD_AdminCenter            = "" ; RSAT_AD_PowerShell             = "" ; RSAT_AD_Tools                  = "" ; 
        RSAT_ADDS                      = "" ; RSAT_ADDS_Tools                = "" ; RSAT_DHCP                      = "" ; 
        RSAT_DNS_Server                = "" ; RSAT_Role_Tools                = "" ; WDS                            = "" ; 
        WDS_AdminPack                  = "" ; WDS_Deployment                 = "" ; WDS_Transport                  = "" ;
        
        InstallDNS                     = "" ; CreateDNSDelegation            = "" ; 
        NoGlobalCatalog                = "" ; CriticalReplicationOnly        = "" ;
        
        DatabasePath                   = "" ; LogPath     = "" ; SysvolPath  = "" ;
        
        Credential  = "" ; DomainName  = "" ; DomainNetBIOSName              = "" ; NewDomainName                  = "" ; 
        NewDomainNetBIOSName           = "" ; SiteName                       = "" ; ReplicationSourceDC            = "" ; 
        
        SafeModeAdministratorPassword  = "" }
    }
<#                                                                                    ____ -- ____    ____ -- ____    ____ -- ____    ____ -- ____      
 ____                                                                              __//¯¯\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//¯¯\\___  
//¯¯\\____________________________________________________________________________/¯¯¯    ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯\\ 
\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯        ____    ____ __ ____ __ ____ __ ____ __ ____ __ ____    ___// 
#>   Function Provision-DSCPromoTable # _________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
    {#/¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯      
        [ CmdLetBinding () ] Param (

            [ Parameter ( Position = 0 , ParameterSetName =      "All" ) ][ Switch ] $All        ,
            [ Parameter ( Position = 0 , ParameterSetName =  "Command" ) ][ Switch ] $Command    ,
            [ Parameter ( Position = 0 , ParameterSetName =  "Process" ) ][ Switch ] $Process    ,
            [ Parameter ( Position = 0 , ParameterSetName =     "Menu" ) ][ Switch ] $Menu       ,
            [ Parameter ( Position = 0 , ParameterSetName =     "Type" ) ][ Switch ] $DomainType ,
            [ Parameter ( Position = 0 , ParameterSetName =      "Top" ) ][ Switch ] $Mode        ,
            [ Parameter ( Position = 0 , ParameterSetName = "Services" ) ][ Switch ] $Services   ,
            [ Parameter ( Position = 0 , ParameterSetName =    "Roles" ) ][ Switch ] $Roles      ,
            [ Parameter ( Position = 0 , ParameterSetName =    "Paths" ) ][ Switch ] $Paths      ,
            [ Parameter ( Position = 0 , ParameterSetName =   "Domain" ) ][ Switch ] $Domain     )
        
        $Table = [ Ordered ]@{ 

            Command    = @( "Forest" ; "" , "" , "Controller" | % { "Domain$_" } ) | % { "Install-ADDS$_" }
            Process    = 0..3
            Menu       =     "Forest" ,       "Tree" ,       "Child" , "Clone"
            DomainType =          "-" , "TreeDomain" , "ChildDomain" ,     "-"
            Mode       = "ForestMode" , "DomainMode" , "ParentDomainName"
            Services   = Get-DSCFeatureList -Underscore
            Roles      = "InstallDNS" , "CreateDNSDelegation" , "NoGlobalCatalog" , "CriticalReplicationOnly"
            Paths      = "Database" ,  "Log" , "Sysvol" | % { "$_`Path" }
            Domain     = @( "Credential" ; "Domain" | % { $_ , "New$_" } | % { $_ , "$_`NetBIOS" } | % { "$_`Name" } ; "ReplicationSourceDC" , "SiteName" )
            Buttons    = "Start" , "Cancel" , "CredentialButton" 
        }

        $Table | % { Return $( If ( $All        ) { $_          } If ( $Command    ) { $_.Command    } If ( $Process    ) { $_.Process  }
                               If ( $Menu       ) { $_.Menu     } If ( $DomainType ) { $_.DomainType } If ( $Mode       ) { $_.Mode     }
                               If ( $Services   ) { $_.Services } If ( $Roles      ) { $_.Roles      } If ( $Paths      ) { $_.Paths    }
                               If ( $Domain     ) { $_.Domain   } ) }                #____ -- ____    ____ -- ____    ____ -- ____    ____ -- ____      
}#____                                                                             __//¯¯\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//¯¯\\___  
#//¯¯\\___________________________________________________________________________/¯¯¯    ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯        ____    ____ __ ____ __ ____ __ ____ __ ____ __ ____    ___// 
    Function Get-DSCPromoSelection # ____________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
    {#/¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯      
        [ CmdLetBinding () ] Param ( [ ValidateSet ( 0 , 1 , 2 , 3 ) ]
        
            [ Parameter (                                                 Position = 0 ) ][            Int ] $Type = 0 ,
            [ Parameter ( Mandatory = $True , ValueFromPipeline = $True , Position = 1 ) ][ Windows.Window ] $GUI      )

            $P                            = $Type
            $B                            = $False , $True
            $Return                       = @( )
            $Code                         = Get-DSCPromoControl

            If ( $ST -eq $Null ) 
            { 
                $ST                       = Get-DSCFeatureState -All 
            }
        # ______________________________________________________________________________ #
        # Command
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Code.Command                 = ( Provision-DSCPromoTable    -Command )[$P]
        # ______________________________________________________________________________ #
        # Process
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Code.Process                 = ( Provision-DSCPromoTable    -Process )[$P]
        # ______________________________________________________________________________ #
        # Menu
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Names                        =   Provision-DSCPromoTable       -Menu
            $Switch                       = @{ 0 = 1,0,0,0 ; 1 = 0,1,0,0 ; 2 = 0,0,1,0 ; 3 = 0,0,0,1 }

            $X                            = $Switch[$P]
                
                0..( $Names.Count - 1 )   | % {  
                    
                    $Y                    = $Names[$_]

                    If ( $X[$_] -eq 0 ) 
                    { 
                        $Code.$Y          = "-" 
                        $GUI.$Y           | % { $_.IsChecked  = $False }
                    }

                    If ( $X[$_] -eq 1 ) 
                    { 
                        $Code.$Y          = "Selected"
                        $GUI.$Y           | % { $_.IsChecked  = $True  }
                    }
                }
        # ______________________________________________________________________________ #
        # Domain Type
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Code.DomainType              = ( Provision-DSCPromoTable -DomainType )[$P]
        # ______________________________________________________________________________ #
        # Mode
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Names                        = Provision-DSCPromoTable -Mode
            $Switch                       = @{ 0 = 1,1,0 ; 1 = 0,1,1 ; 2 = 0,1,1  ; 3 = 0,0,0 }
        
            $X                            = $Switch[$P]
            
                0..( $Names.Count - 1 )   | % { 

                    $Y                    = $Names[$_]

                    If ( $Y -eq $Names[2] ) 
                    { 
                        $GUI.$Y           | % { $_.Text = '' }
                    }

                    If ( $X[$_] -eq 0 )
                    { 
                        $Code.$Y          = '-' 
                        $GUI."$Y`Box"     | % { $_.Visibility = "Collapsed" }
                    }
                    
                    If ( $X[$_] -eq 1 )
                    { 
                        $Code.$Y          = '' 
                        $GUI."$Y`Box"     | % { $_.Visibility = "Visible"   }
                        $Return          += $Y
                    }
                }
        # ______________________________________________________________________________ #
        # Services
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Names                        = Provision-DSCPromoTable -Services
            $Switch                       = 0..16 | % { $ST[$_][-2] } | % { If ( $_ -eq "X" ) { 0 } Else { 1 } }
            
                0..( $Names.Count - 1 )   | % { 

                    $X , $Y               = $Switch[$_] , $Names[$_]

                    $GUI.$Y               | % { $_.IsEnabled = $False ; $_.IsChecked = $True }

                    If ( $X -eq 0 ) 
                    { 
                        $Code.$Y          = 'Installed' 
                    }

                    If ( $X -eq 1 ) 
                    { 
                        $Code.$Y          = 'Available'
                        $GUI.$Y           | % { $_.IsEnabled = $True }
                    }

                }
        # ______________________________________________________________________________ #
        # Roles
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Names                        = Provision-DSCPromoTable -Roles
            $Switch                       = @{ 0 = 1,1,0,0 ; 1 = 1,1,1,0 ; 2 = 1,1,1,0 ; 3 = 1,1,1,1 }
            $Default                      = @{ 0 = 1,0,0,0 ; 1 = 1,0,0,0 ; 2 = 1,1,0,0 ; 3 = 1,0,0,0 }
            
            $X                            = $Switch[$P]

                0..( $Names.Count - 1 )   | % {  

                    $Y                    = $Names[$_]

                    $GUI.$Y               | % { $_.IsEnabled = $False ; $_.IsChecked = $True }
                    
                    If ( $X[$_] -eq 0 ) 
                    { 
                        $Code.$Y          = '-' 
                    }

                    If ( $X[$_] -eq 1 ) 
                    { 
                        $Code.$Y          = $X[$_]
                        $GUI.$Y.IsEnabled = $B[$Default[$P][$_]]
                        $Return          += $Y 
                    }
                }
        # ______________________________________________________________________________ #
        # Paths
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Names                        = Provision-DSCPromoTable -Paths
            $Default                      = "NTDS" , "NTDS" , "SYSVOL" | % { "C:\Windows\$_" }
            
                0..( $Names.Count - 1 )   | % { 

                    $Y                    = $Names[$_]
                    $Code.$Y              = $Default[$_]
                    $GUI.$Y.Text          = $Default[$_]
                }
        # ______________________________________________________________________________ #
        # Domain
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Names                        = Provision-DSCPromoTable -Domain
            $Switch                       = @{ 0 = 0,1,1,0,0,0,1 ; 1 = 1,0,0,1,1,0,1 ; 2 = 1,0,0,1,1,0,1 ; 3 = 1,1,0,0,0,1,1 }
            
            $X                            = $Switch[$P]

                0..( $Names.Count - 1 )   | % { 
                    
                    $Y                    = $Names[$_]
                    $GUI.$Y               | % { $_.Text = "" }

                    If ( $X[$_] -eq 0 ) 
                    { 
                        $Code.$Y          = '-' ; 
                        $GUI."$Y`Box"     | % { $_.Visibility = "Collapsed" }
                    }

                    If ( $X[$_] -eq 1 ) 
                    { 
                        $Code.$Y          = ''
                        $GUI."$Y`Box"     | % { $_.Visibility =   "Visible" }
                        $Return          += $Y
                    }
                }
        # ______________________________________________________________________________ #
        # DSRM
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            "Credential" | % {
                
                $GUI.$_                   | % { 
                
                    $_.IsEnabled          = $False
                    $_.Text               = "" 
                }
                
                $Code.$_                  = ""
                $Return                  += "SafeModeAdministratorPassword"
            
            }

            Return [ PSCustomObject ]@{ 
            
                Code                      = $Code
                Window                    = $GUI
                Profile                   = $Return 
            }
                                                                                     #____ -- ____    ____ -- ____    ____ -- ____    ____ -- ____      
}#____                                                                             __//¯¯\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//¯¯\\___  
#//¯¯\\___________________________________________________________________________/¯¯¯    ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯        ____    ____ __ ____ __ ____ __ ____ __ ____ __ ____    ___// 
    Function Provision-DomainController # Launches Hybrid-DSCPromo ______________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
    {#/¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯      
        
        Write-Theme -Action "Searching [~]" "For Valid Domain Controllers" 11 12 15
        
        $Report                           = Get-NBTScan | ? { $_.ID -eq "<1C>" } 

        Write-Theme -Action "Loading [~]" "Active Directory Configuration Utility" 11 12 15

        $P                                = 0
        
        $GUI = Get-XAML -HybridDSCPromo   | % { 
        
            Convert-XAMLToWindow -XAML $_ -NE ( Find-XAMLNamedElements -Xaml $_ ) -PassThru 
        }

        Get-DSCPromoSelection -Type 0 -GUI $GUI | % { $Code = $_.Code ; $GUI = $_.Window ; $Return = $_.Profile }
        
        $Named                            = Find-XAMLNamedElements -Xaml ( Get-XAML -HybridDSCPromo )
        
        $Menu                             = Provision-DSCPromoTable -Menu

        0..( $Menu.Count - 1 )            | % { 
        
            IEX "`$GUI.`$( `$Menu[$_] ).Add_Click({ 
        
                Get-DSCPromoSelection -Type $_ -GUI `$GUI | % { 
            
                    `$Code                = `$_.Code ; 
                    `$GUI                 = `$_.Window ; 
                    `$Return              = `$_.Profile }
            })"
        }

        $Service                          = Provision-DSCPromoTable -Services

        0..( $Service.Count - 1 )         | % {

            IEX "`$GUI.`$( `$Service[$_] ) | ? { `$_.IsEnabled } | % { 
        
            `$_.Add_UnChecked({ `$Code.`$( `$Service[$_] ) = 0 })
              `$_.Add_Checked({ `$Code.`$( `$Service[$_] ) = 1 }) 
            }"
        }

        $GUI.CredentialButton.Add_Click({

            $Alternate                    = 0

            If ( $Report -ne $Null ) 
            {
                $Report                   | % { 
                
                    $DC                   = $_.Host.Split( '.' )[0]
                    $Domain               = $_.Host.Replace( "$DC." , '' )
                    $NetBIOS              = $_.Name 
                }

                $Popup                    = Get-XAML -DCFound | % { 
                
                    Convert-XAMLToWindow -XAML $_ -NE ( Find-XAMLNamedElements -XAML $_ ) -PassThru 
                }

                $Popup                    | % { 

                    $_.Ok                 | % { $_.Add_Click({ $Popup.DialogResult =  $True }) }
                    $_.Cancel             | % { $_.Add_Click({ $Popup.DialogResult = $False }) }
                    $_.DC                 | % { $_.Content = $DC      }
                    $_.Domain             | % { $_.Content = $Domain  }
                    $_.NetBIOS            | % { $_.Content = $NetBIOS }

                    $Null                 = $_.Ok.Focus()

                    $PopupResult          = Show-WPFWindow -GUI $_

                }

                If ( $PopupResult -eq $True )
                {
                    $DCCred               = Enter-ServiceAccount -DC $DC -Domain $Domain
                }

                Else 
                {
                    $Alternate            = 1
                }
            }

            If ( ( $Report -eq $Null ) -or ( $Alternate -eq 1 ) )
            {
                $X = $( If ( $Code.Process -in 1,2 ) { $GUI.ParentDomainName  | % { $_.Text } }
                        If ( $Code.Process -eq 3   ) { $GUI.DomainName        | % { $_.Text } } )

                If ( ( $X -eq "" ) -or ( $X -eq $Null ) )
                {
                    Show-Message "Error" "Domain Name is Null/Empty"
                    Return
                }

                Else
                {
                    $X | % {

                        If ( $Code.Process -eq 3 -and ( Validate-DomainName -Domain $X ) -ne $X )
                        {
                            Show-Message "Error" , "$X in Parent Domain Name"
                            Return
                        }
                    
                        Else
                        {
                            Resolve-DNSName $_ -Type A | % { Resolve-DNSName $_.IPAddress } | % { $Y = $_.NameHost.Replace( ".$X" , '' ) }
                            If ( $Y -eq $Null ) { [ System.Windows.MessageBox ]::Show( "Failed to detect the domain controller" , "Error" ) ; Return }
                        }
                    }

                    $DCCred = Enter-ServiceAccount -DC $Y -Domain $X 
                }
            } 

            If ( $DCCred -ne $Null ) 
            { 
                $GUI.Credential    | % { $_.Text = $DCCred.UserName ; $_.IsEnabled = $False }
                $Code.Credential   = $DCCred

                If ( $Code.Process -in 1 , 2 ) 
                {
                    $GUI.ParentDomainName.Text = $X
            
                    $AD = "LDAP://$( $DC )/CN=Partitions,CN=Configuration,DC=$( $Domain.Split('.') -join ',DC=' )"

                    $Searcher = [ DirectorySearcher ]::New() | % {
                        $_.SearchRoot = [ DirectoryEntry ]::New( $AD , $DCCred.Username , $DCCred.GetNetworkCredential().Password )
                        $_.PageSize   = 1000
                        $_.PropertiesToLoad.Clear()
                    }

                    $EXE = $Searcher.FindAll()
                    0..( $EXE.Count - 1 ) | % { $EXE[$_].Properties } | ? { $_.netbiosname } | % { $NBIOS = $_.netbiosname }
                }

                Else { $GUI.DomainName.Text = $X }
            }

            If ( $DCCred -eq $Null )
            {
                Write-Theme -Action "Exception [!]" "Login Failed" 12 4 15 
            }
        })

        $GUI.Cancel.Add_Click( { $GUI.DialogResult = $False } )

        $Return

    }

    Function Code-Process
    {

        If ( $Code.Process -eq 0 )
        {
            $GUI.DomainName           | % { $_.Text | % { 
            
                    $X = Validate-DomainName -Domain $_
                    If ( $X -eq $_ ) { $Code.DomainName           = $_ } 
                    Else             { Show-Message -Message        $X } 
                }
            }

            $GUI.DomainNetBIOSName    | % { $_.Text | % { 
            
                    $X = Validate-DomainName -NetBIOS $_ 
                    If ( $X -eq $_ ) { $Code.DomainNetBIOSName    = $_ } 
                    Else             { Show-Message -Message        $X } 
                }
            }
        }

        Else 
        {
            $GUI.Credential           | % { If ( $_.Text -eq "" ) { Show-Message -Message "Credential Missing" } }
        }

        If ( $Code.Process -in 1,2 )
        {
            $GUI.ParentDomainName     | % { $_.Text | % { 
            
                If ( $_ -eq "" ) { 
                    $X = Validate-DomainName -Domain $_
                    If ( $X -eq $_ ) { $Code.ParentDomainName     = $_ } 
                    Else             { Show-Message -Message        $X } 
                }
            }
            
            If ( $Code.Process -eq 1 )
            {
                $GUI.NewDomainName | % { 
                
                    If ( $_.Text -like "*$( $GUI.ParentDomainName )*" )
                    {
                        Show-Message -Message "New Domain Name is too similar to Parent Domain"
                    }

                    Else 
                    {
                        $_.Text | % { 
            
                            $X = Validate-DomainName -Domain $_
                            If ( $X -eq $_ ) { $Code.NewDomainName        = $_ } 
                            Else             { Show-Message -Message        $X } 
                        }
                    }
                }
            If ( $Code.Process -eq 2 )
            {
                $GUI.NewDomainName | % {

                    If ( $_.Text 
            
            $GUI.ParentDomainName     | % { $_.Text | % { 
            
                    $X = Validate-DomainName -Domain $_
                    If ( $X -eq $_ ) { $Code.ParentDomainName     = $_ } 
                    Else             { Show-Message -Message        $X } 
                }
            }
            $GUI.ParentDomainName     | % { $_.Text | % { If ( ( Validate-DomainName -Domain $_ ) -eq $_ ) { $Code.ParentDomainName     = $_ } } }
            $GUI.NewDomainName        | % { $_.Text | % { If ( ( Validate-DomainName -Domain $_ ) -eq $_ ) { $Code.NewDomainName        = $_ } } }
            $GUI.NewDomainNetBIOSName | % { $_.Text | % { If ( ( Validate-DomainName -Domain $_ ) -eq $_ ) { $Code.NewDomainNetBIOSName = $_ } } }
        }

        If ( $Code.Process -eq 3 )
        {
            $GUI.DomainName           | % { $_.Text | % { If ( ( Validate-DomainName -Domain $_ ) -eq $_ ) { $Code.DomainName           = $_ } } }
            $GUI.ReplicationSourceDC  | % { $_.Text | % { If ( ( Validate-DomainName -Domain $_ ) -eq $_ ) { $Code.ReplicationSourceDC  = $_ } } }
        }

        $GUI.$_.Text | % { Validate-DomainName -SiteName }

        "SafeModeAdministratorPassword" | % { 
        
            If     ( $GUI.$_.Password -eq "" )                          { Show-Message -Message "DSRM is empty"         }
            ElseIf ( $GUI.$_.Password.Length -lt 8 )                    { Show-Message -Message "Password is too short" }
            ElseIf ( $GUI.$_.Password -notmatch $GUI.Confirm.Password ) { Show-Message -Message "Invalid Confirmation"  }
            Else { $Code.$_ = $GUI.$_.SecurePassword }
        }

        "ForestMode" , "DomainMode"    | ? { $_ -in $Return } | % { $Code.$_ = $GUI.$_.SelectedIndex }
        Provision-DSCPromoTable -Roles | ? { $_ -in $Return } | % { $Code.$_ = $GUI.$_.IsChecked     }

            If ( $P -in 1..2 )
            {
                If ( $GUI.ParentDomainName | % { $_.Text -eq ""  } ) 
                { 
                    Show-Message -Message "Parent Domain Name Missing"
                }

                ElseIf ( $GUI.CredentialBox | % { $_.Text -eq ""  } ) 
                { 
                    Show-Message -Message "Domain Credential Missing"
                }
                
                ElseIf ( $GUI.NewDomainNetBIOSName | % { $_.Text -eq $NBIOS } ) 
                { 
                    Show-Message -Message "NetBIOS name is already used"
                }
                    
                ElseIf ( $Code.Process -eq 1 )
                {
                    If ( $GUI.NewDomainName | % { $_.Text -like "*$( $GUI.ParentDomainName.Text )*" } )
                    { 
                        Show-Message -Message "Name is too similar"
                    }
                }
            }

            If ( $P -eq 1 ) # Install-ADDSDomain Tree
            {       
                $Return.Top      = $Process.Top[1]      | % { $Code.$_ = $GUI.$_.SelectedIndex }
                $Return.Top.Add( $Process.Top[2] , ( $Process[2] | % { $Code.$_ = $GUI.$_.Text } ) )
                $Return.Roles    = $Process.Roles[0..2] | ? { $GUI.$_.IsEnabled } | % { $Code.$_ = $GUI.$_.IsChecked }
                $Return.Item     = $Process.Domain[3,4,6] | % { $GUI.$_.Text }
                $Return.Message  = "New Domain" | % { "$_" , "$_ NetBIOS" , "Site" } | % { "$_ Name" }
                $Return.Command  = $Process.Command[0,1,2]
            }

            If ( $P -eq 2 ) # Install-ADDSDomain Child
            {       
                $Return.Top      = $Process.Top[1]        | % { $Code.$_ = $GUI.$_.SelectedIndex }
                $Return.Top.Add( $Process.Top[2] , ( $Process[2] | % { $Code.$_ = $GUI.$_.Text } ) )
                $Return.Roles    = $Process.Roles[0..2]   | ? { $GUI.$_.IsEnabled } | % { $Code.$_ = $GUI.$_.IsChecked }
                $Return.Item     = $Process.Domain[3,4,6] | % { $GUI.$_.Text }
                $Return.Message  = "New Domain" | % { "$_" , "$_ NetBIOS" , "Site" } | % { "$_ Name" }
                $Return.Command  = $Process.Command[2,1,2]
            }

            If ( $P -eq 3 ) # Install-ADDSDomainController
            {
                $Return.Top      = ""
                $Return.Roles    = $Process.Roles[0..3] | ? { $GUI.$_.IsEnabled } | % { $Code.$_ = $GUI.$_.IsChecked }
                $Return.Item     = $Process.Domain[1,5,6] | % { $GUI.$_.Text }
                $Return.Message  = "Domain Name" , "Replication Source DC" , "Site Name"
                $Return.Command  = $Process.Command[1,4,2]
            }

            If ( $P -in 0..3 ) 
            { 
                $Valid   = 0..2
                $Message = 0..2
                $Item    = 0..2 
                0..2 | % { 
                
                    $Valid[$_]   = IEX "$( $Return.Command[$_] ) $( $Return.Item[$_] )"
                    $Message[$_] = "[ System.Windows.MessageBox ]::Show( '$( $Return.Message[$_] ) field was empty' )"
                    $Item[$_]    = "[ System.Windows.MessageBox ]::Show( '$( $Return.Item[$_] ) failed validation' )"
                    }
            }

            ElseIf ( $Return.Item[0] -eq "" ) { IEX $Message[0] }
            ElseIf ( $Return.Item[1] -eq "" ) { IEX $Message[0] }
            ElseIf ( $Return.Item[2] -eq "" ) { IEX $Message[0] }
            
            ElseIf ( $Return.Item[0] -ne $Valid[0] ) { IEX $Item[0] }
            ElseIf ( $Return.Item[1] -ne $Valid[1] ) { IEX $Item[1] }
            ElseIf ( $Return.Item[2] -ne $Valid[2] ) { IEX $Item[2] }
            
            Else { 0..2 | % { $Code.$( $Return.Item[$_] ) = $GUI.$( $Return.Item[$_] ) } }
        }
