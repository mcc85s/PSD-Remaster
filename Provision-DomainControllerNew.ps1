# ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____ -- ____  
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\   ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯   //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//  [ Secure Digits Plus LLC | Hybrid | Desired State Controller ]  \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯       _____________________________________________________        ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯        __/¯¯\__[ Dynamically Engineered Digital Security ]__/¯¯\__         ¯¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\  _________________________ ________________ ___________________________________  //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__// | Application Development | Virtualization | Network and Hardware Magistration | \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\  ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯  //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//   https://www.securedigitsplus.com | Server-Client | Seedling-Spawning Script    \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\___¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯   ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ ___//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\   [ Provisional Author : Michael C Cook Sr. | "The Buck Stops Here" ]    //¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__// 
#//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//   ____    ____    ____    ____    ____    ____    ____    ____    ____   \\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\ 
#\\__/====\__/----\__/====\__/----\__/====\__/----\__/====\__/----\__/====\__/----\__/====\__/----\__/====\__/----\__/====\__/----\__/====\__/----\__// 
#//¯¯¯    
#\\  [ Provision-DomainController ] @: Orchestrates the process of provisioning server prerequisites in order to install Hybrid-DSC                     
#//   ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____    ____      
#\\__/----\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//==\\__/---\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//==\\___  
#//¯¯\\___________________________________________________________________________________¯¯¯¯ -- ¯¯¯¯ ¯¯ ¯¯¯¯ -- ¯¯¯¯ ¯¯ ¯¯¯¯ -- ¯¯¯¯ ¯¯ ¯¯¯¯ -- ¯¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯\\___ __ ____ -- ____ __ ____ -- ____ __ ____ -- ____ __ ___// 
# ¯¯¯¯   [ Declare Namespaces & Load Modules ] __________________________________________//¯¯\----/¯¯\\==//¯¯\----/¯¯\\==//¯¯\----/¯¯\\==//¯¯\----/¯¯¯  
     #/¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯    ¯¯¯¯      
        "Security.Principal" , "Management.Automation" , "DirectoryServices" | % { IEX "Using Namespace System.$_" } 
    
        $ENV:PSModulePath.Split( ';' ) | % { GCI $_ -Recurse "Hybrid-DSC.psm1" } | % {
        
        IPMO $_.FullName -Force ; If ( $? -ne $True ) { Write-Error "Module Not Loaded/Found" ; Read-Host "Press Enter to Exit" ; Exit }     
                                                                                     #____ -- ____    ____ -- ____    ____ -- ____    ____ -- ____      
}#____                                                                             __//¯¯\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//¯¯\\___  
#//¯¯\\___________________________________________________________________________/¯¯¯    ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯        ____    ____ __ ____ __ ____ __ ____ __ ____ __ ____    ___// 
    Function Enter-ServiceAccount # Allows entry / use of an AD service account _________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
    {#/¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯      
        [ CmdLetBinding () ] Param (

            [ Parameter ( Position = 0 , Mandatory = $True , ValueFromPipeline = $True ) ] [ String ] $DC      ,
            [ Parameter ( Position = 1 , Mandatory = $True , ValueFromPipeline = $True ) ] [ String ] $Domain  ,
            [ Parameter ( Position = 2 , ValueFromPipeline = $True ) ]                     [ String ] $NetBIOS )
                                                                                                                
        $Login = Get-XAML -Login

        $NamedElements = "Username" , "Password" , "Confirm" , "Switch" , "Port" , "Ok" , "Cancel"

        $0    = "Username" , "Password" , "Confirmation"
        $1    = $0 | % { "You must enter a $_" } ; $2 = $0 | % { "$_ Error" }
        $1[2] = $1[2].Replace( "You must enter a" , "Password Must Match the" )
        $1   += "Invalid information. All fields must be correct and valid." ; 
        $2   += "Authentication Failure"

        $MSG  = 0..3 | % { "[ System.Windows.MessageBox ]::Show( '$( $1[$_] )' , '$( $2[$_] )' )" }

        $GUI = Convert-XAMLtoWindow -Xaml $Login -NE $NamedElements -PassThru

        $GUI.Switch.Add_Click({ $GUI.Port.IsEnabled = $True  })
        $GUI.Cancel.Add_Click({ $GUI.DialogResult   = $False })
        $GUI.Ok.Add_Click({

            $Port = $( If ( $GUI.Port.IsEnabled -eq $True ) { $GUI.Port.Text } Else { 389 } )
            $Cred = [ PSCredential ]::New( $GUI.Username.Text , $GUI.Password.SecurePassword )
            $AD   = "LDAP://$( $DC ):$Port/DC=$( $Domain.Split('.') -join ',DC=' )"
            $DX   = [ DirectoryEntry ]::New( "$AD" , $Cred.Username , $Cred.GetNetworkCredential().Password )

                If ( $GUI.Username | ? { $_.Text     -eq $Null } )                     { IEX $MSG[0] }
            ElseIf ( $GUI.Password | ? { $_.Password -eq $Null } )                     { IEX $MSG[1] }
            ElseIf ( $GUI.Confirm  | ? { $_.Password -eq $Null } )                     { IEX $MSG[2] }
            ElseIf ( $GUI | ? { $_.Password.Password -notmatch $_.Confirm.Password } ) { IEX $MSG[2] }
            ElseIf ( $DX.Name -eq $Null )                                              { IEX $MSG[3] }

            Else { $GUI.DialogResult = $True }
        })

        $Null = $GUI.Username.Focus()

        $OP = Show-WPFWindow -GUI $GUI

        If ( $OP -eq $True )
        {
            Write-Theme -Action "Login [+]" "Successful" 11 12 15
            Return [ PSCredential ]::New( $GUI.Username.Text , $GUI.Password.SecurePassword )
        }

        Else
        {
            Write-Theme -Action "Login [!]" "Failed" 12 4 15
        }                                                                            #____ -- ____    ____ -- ____    ____ -- ____    ____ -- ____      
}#____                                                                             __//¯¯\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//¯¯\\___  
#//¯¯\\___________________________________________________________________________/¯¯¯    ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯        ____    ____ __ ____ __ ____ __ ____ __ ____ __ ____    ___// 
    Function Validate-DomainName # Verfies that text entries are valid __________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
    {#/¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯      
        [ CmdLetBinding () ] [ OutputType ( "String" ) ] Param (

            [ Parameter ( Mandatory = $True , ParameterSetName = "0" ) ][ Switch ] $Domain ,
            [ Parameter ( Mandatory = $True , ParameterSetName = "1" ) ][ Switch ] $NetBIOS ,
            [ Parameter ( Mandatory = $True , ParameterSetName = "2" ) ][ Switch ] $SiteName ,
            [ Parameter ( Mandatory = $True , ParameterSetName = "0" ) ]
            [ Parameter ( Mandatory = $True , ParameterSetName = "1" ) ]
            [ Parameter ( Mandatory = $True , ParameterSetName = "2" ) ][ String ] $Name )

            $Char = "abcdefghijklmnopqrstuvwxyz0123456789.-\/:*?$( '"' )<>|,~:!@#$%^&'(){}_ "
            $Char | % { $AL =    $_[0..25] ; $NU =   $_[26..35] ; $SP = $_[38..64] ;
                        $AN = $Char[0..35] ; $NN = $Char[0..25] }
            $DNS  = @{ Min = 2 ; Max = 255 ; Allow = $Char[ 0..37] ; Invalid = $SP }
            $NBT  = @{ Min = 1 ; Max =  15 ; Allow = $Char[ 0..37] ; Invalid = $SP }
            $SN   = @{ Min = 1 ; Max =  63 ; Allow = $Char[ 0..37] ; Invalid = $SP }

            $Reserved = @( "ANONYMOUS" , "AUTHENTICATED USER" , "BATCH" , "BUILTIN" ; 
            "GROUP" , "OWNER" | % { $_ , "$_ SERVER" } | % { "CREATOR $_" } ;
            "DIALUP" , "DIGEST AUTH" , "INTERACTIVE" , "INTERNET" ;
            "LOCAL" | % { $_ , "$_ SYSTEM" } ; "NETWORK" | % { $_ , "$_ SERVICE" } ;
            "NT AUTHORITY" , "NT DOMAIN" , "NTLM AUTH" , "NULL" , "PROXY" , "REMOTE INTERACTIVE" , "RESTRICTED" , 
            "SCHANNEL AUTH" , "SELF" , "SERVER" , "SERVICE" , "SYSTEM" , "TERMINAL SERVER" , "THIS ORGANIZATION" , "USERS" , "WORLD" )

            $X = $( If ( $Domain ) { $DNS } If ( $NetBIOS  ) { $NBT } If ( $SiteName ) { $SN } )

                If ( $Name.Length -lt $X.Min ) { Return "Short of minimum length" }
            ElseIf ( $Name.Length -gt $X.Max ) { Return  "Exceeds maximum length" }
            ElseIf ( ( $Name.ToCharArray() | ? { $_ -notin $X.Allow } ).Count -gt 0 ) { Return "Invalid Characters" }
            ElseIf ( ( $Name.ToCharArray() | ? { $_  -in $X.Invalid } ).Count -gt 0 ) { Return "Invalid Characters" }

            If ( ( $Domain ) -or ( $SiteName ) ) 
            {
                If ( ( $Name[0] | ? { $_ -notin $AN } ).Count -gt 0 )
                { 
                    Return "First character must be Alpha-Numeric"
                }
                    
                ElseIf (   $Name | % { $_.EndsWith( "." ) -or $_.EndsWith( "-" ) } )  
                { 
                    Return "Last Character cannot be a period/hyphen" 
                }
            }
            
            If ( $Domain )
            {
                If ( $Name.Split( '.' ).Count -le 1 )
                { 
                    Return "Not a valid domain name" 
                }
                
                ElseIf ( ( $Name.Split( '.' )[-1].ToCharArray() | ? { $_ -in @( $AL ; '-' , '.' ) } ).Count -eq 0 )
                { 
                    Return "Top Level Domain must contain a non-numeric character" 
                }
                
                Else
                { 
                    Return $Name 
                }                                                                                    
            }

            If ( $SiteName )
            {
                If ( $X -in $Reserved ) 
                { 
                    Return "The selected name conflicts with a reservation" 
                }
                
                Else 
                { 
                    Return $Name 
                }    
            }
 
            If ( $NetBIOS )
            { 
                If ( $Name[0] -eq "." )
                {
                    Return "First Character must be Alpha-Numeric, or '.' "
                }
            
                Else 
                { 
                    Return $Name.ToUpper() 
                }
            }                                                                        #____ -- ____    ____ -- ____    ____ -- ____    ____ -- ____      
}#____                                                                             __//¯¯\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//¯¯\\___  
#//¯¯\\___________________________________________________________________________/¯¯¯    ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯        ____    ____ __ ____ __ ____ __ ____ __ ____ __ ____    ___// 
    Function Get-DSCPromoControl # Provides backend for reliable XAML Control ___________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
    {#/¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯      
        Return [ PSCustomObject ]@{
        # ______________________________________________________________________________ #
        # Command 
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            Command     = "" ; 
        # ______________________________________________________________________________ #
        # Process 
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            Process     = "" ;
        # ______________________________________________________________________________ #
        # Menu 
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            Forest      = "" ; Tree        = "" ; Child       = "" ; Clone       = "" ; 
        # ______________________________________________________________________________ #
        # DomainType 
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            DomainType  = "" ; 
        # ______________________________________________________________________________ #
        # Mode
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            ForestMode  = "" ; DomainMode  = "" ; ParentDomainName               = "" ;
        # ______________________________________________________________________________ #
        # Services
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            AD_Domain_Services             = "" ; 
            DHCP        = "" ; DNS         = "" ; GPMC        = "" ; RSAT        = "" ; 
            RSAT_AD_AdminCenter            = "" ; RSAT_AD_PowerShell             = "" ; 
            RSAT_AD_Tools                  = "" ; RSAT_ADDS                      = "" ; 
            RSAT_ADDS_Tools                = "" ; RSAT_DHCP                      = "" ; 
            RSAT_DNS_Server                = "" ; RSAT_Role_Tools                = "" ; 
            WDS                            = "" ; WDS_AdminPack                  = "" ; 
            WDS_Deployment                 = "" ; WDS_Transport                  = "" ;
        # ______________________________________________________________________________ #
        # Roles
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            InstallDNS                     = "" ; CreateDNSDelegation            = "" ; 
            NoGlobalCatalog                = "" ; CriticalReplicationOnly        = "" ;
        # ______________________________________________________________________________ #
        # Paths
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            DatabasePath                   = "" ; LogPath     = "" ; SysvolPath  = "" ;
        # ______________________________________________________________________________ #
        # Domain
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            Credential  = "" ; DomainName  = "" ; DomainNetBIOSName              = "" ; 
            NewDomainName                  = "" ; NewDomainNetBIOSName           = "" ;
            SiteName                       = "" ; ReplicationSourceDC            = "" ; 
            SafeModeAdministratorPassword  = "" }                                    #____ -- ____    ____ -- ____    ____ -- ____    ____ -- ____      
}#____                                                                             __//¯¯\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//¯¯\\___  
#//¯¯\\___________________________________________________________________________/¯¯¯    ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯        ____    ____ __ ____ __ ____ __ ____ __ ____ __ ____    ___// 
    Function Provision-DSCPromoTable # __________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
    {#/¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯      
        [ CmdLetBinding () ] Param (

            [ Parameter ( Position = 0 , ParameterSetName =      "All" ) ][ Switch ] $All        ,
            [ Parameter ( Position = 0 , ParameterSetName =  "Command" ) ][ Switch ] $Command    ,
            [ Parameter ( Position = 0 , ParameterSetName =  "Process" ) ][ Switch ] $Process    ,
            [ Parameter ( Position = 0 , ParameterSetName =     "Menu" ) ][ Switch ] $Menu       ,
            [ Parameter ( Position = 0 , ParameterSetName =     "Type" ) ][ Switch ] $DomainType ,
            [ Parameter ( Position = 0 , ParameterSetName =      "Top" ) ][ Switch ] $Mode        ,
            [ Parameter ( Position = 0 , ParameterSetName = "Services" ) ][ Switch ] $Services   ,
            [ Parameter ( Position = 0 , ParameterSetName =    "Roles" ) ][ Switch ] $Roles      ,
            [ Parameter ( Position = 0 , ParameterSetName =    "Paths" ) ][ Switch ] $Paths      ,
            [ Parameter ( Position = 0 , ParameterSetName =   "Domain" ) ][ Switch ] $Domain     )
        
        $Table = [ Ordered ]@{ 

            Command    = @( "Forest" ; "" , "" , "Controller" | % { "Domain$_" } ) | % { "Install-ADDS$_" }
            Process    = 0..3
            Menu       =     "Forest" ,       "Tree" ,       "Child" , "Clone"
            DomainType =          "-" , "TreeDomain" , "ChildDomain" ,     "-"
            Mode       = "ForestMode" , "DomainMode" , "ParentDomainName"
            Services   = Get-DSCFeatureList -Underscore
            Roles      = "InstallDNS" , "CreateDNSDelegation" , "NoGlobalCatalog" , "CriticalReplicationOnly"
            Paths      = "Database" ,  "Log" , "Sysvol" | % { "$_`Path" }
            Domain     = @( "Credential" ; "Domain" | % { $_ , "New$_" } | % { $_ , "$_`NetBIOS" } | % { "$_`Name" } ; "ReplicationSourceDC" , "SiteName" )
            Buttons    = "Start" , "Cancel" , "CredentialButton" 
        }

        $Table | % { Return $( If ( $All        ) { $_          } If ( $Command    ) { $_.Command    } If ( $Process    ) { $_.Process  }
                               If ( $Menu       ) { $_.Menu     } If ( $DomainType ) { $_.DomainType } If ( $Mode       ) { $_.Mode     }
                               If ( $Services   ) { $_.Services } If ( $Roles      ) { $_.Roles      } If ( $Paths      ) { $_.Paths    }
                               If ( $Domain     ) { $_.Domain   } ) }                #____ -- ____    ____ -- ____    ____ -- ____    ____ -- ____      
}#____                                                                             __//¯¯\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//¯¯\\___  
#//¯¯\\___________________________________________________________________________/¯¯¯    ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯        ____    ____ __ ____ __ ____ __ ____ __ ____ __ ____    ___// 
    Function Get-DSCPromoSelection # ____________________________________________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
    {#/¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯      
        [ CmdLetBinding () ] Param ( [ ValidateSet ( 0 , 1 , 2 , 3 ) ]
        
            [ Parameter (                                                 Position = 0 ) ][            Int ] $Type = 0 ,
            [ Parameter ( Mandatory = $True , ValueFromPipeline = $True , Position = 1 ) ][ Windows.Window ] $GUI      )

            $P                            = $Type
            $B                            = $False , $True
            $Return                       = @( )
            $Code                         = Get-DSCPromoControl

            If ( $ST -eq $Null ) 
            { 
                $ST                       = Get-DSCFeatureState -All 
            }
        # ______________________________________________________________________________ #
        # Command
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Code.Command                 = ( Provision-DSCPromoTable    -Command )[$P]
        # ______________________________________________________________________________ #
        # Process
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Code.Process                 = ( Provision-DSCPromoTable    -Process )[$P]
        # ______________________________________________________________________________ #
        # Menu
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Names                        =   Provision-DSCPromoTable       -Menu
            $Switch                       = @{ 0 = 1,0,0,0 ; 1 = 0,1,0,0 ; 2 = 0,0,1,0 ; 3 = 0,0,0,1 }

            $X                            = $Switch[$P]
                
                0..( $Names.Count - 1 )   | % {  
                    
                    $Y                    = $Names[$_]

                    If ( $X[$_] -eq 0 ) 
                    { 
                        $Code.$Y          = "-" 
                        $GUI.$Y           | % { $_.IsChecked  = $False }
                    }

                    If ( $X[$_] -eq 1 ) 
                    { 
                        $Code.$Y          = "Selected"
                        $GUI.$Y           | % { $_.IsChecked  = $True  }
                    }
                }

        # ______________________________________________________________________________ #
        # Domain Type
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Code.DomainType              = ( Provision-DSCPromoTable -DomainType )[$P]
        # ______________________________________________________________________________ #
        # Mode
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Names                        = Provision-DSCPromoTable -Mode
            $Switch                       = @{ 0 = 1,1,0 ; 1 = 0,1,1 ; 2 = 0,1,1  ; 3 = 0,0,0 }
        
            $X                            = $Switch[$P]
            
                0..( $Names.Count - 1 )   | % { 

                    $Y                    = $Names[$_]

                    If ( $Y -eq $Names[2] ) 
                    { 
                        $GUI.$Y           | % { $_.Text = '' }
                    }

                    If ( $X[$_] -eq 0 )
                    { 
                        $Code.$Y          = '-' 
                        $GUI."$Y`Box"     | % { $_.Visibility = "Collapsed" }
                    }
                    
                    If ( $X[$_] -eq 1 )
                    { 
                        $Code.$Y          = '' 
                        $GUI."$Y`Box"     | % { $_.Visibility = "Visible"   }
                        $Return          += $Y
                    }
                }
        # ______________________________________________________________________________ #
        # Services
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Names                        = Provision-DSCPromoTable -Services
            $Switch                       = 0..16 | % { $ST[$_][-2] } | % { If ( $_ -eq "X" ) { 0 } Else { 1 } }
            
                0..( $Names.Count - 1 )   | % { 

                    $X , $Y               = $Switch[$_] , $Names[$_]

                    $GUI.$Y               | % { $_.IsEnabled = $False ; $_.IsChecked = $True }

                    If ( $X -eq 0 ) 
                    { 
                        $Code.$Y          = 'Installed' 
                    }

                    If ( $X -eq 1 ) 
                    { 
                        $Code.$Y          = 'Available'
                        $GUI.$Y           | % { $_.IsEnabled = $True }
                    }

                }
        # ______________________________________________________________________________ #
        # Roles
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Names                        = Provision-DSCPromoTable -Roles
            $Switch                       = @{ 0 = 1,1,0,0 ; 1 = 1,1,1,0 ; 2 = 1,1,1,0 ; 3 = 1,1,1,1 }
            $Default                      = @{ 0 = 1,0,0,0 ; 1 = 1,0,0,0 ; 2 = 1,1,0,0 ; 3 = 1,0,0,0 }
            
            $X                            = $Switch[$P]

                0..( $Names.Count - 1 )   | % {  

                    $Y                    = $Names[$_]

                    $GUI.$Y               | % { $_.IsEnabled = $False ; $_.IsChecked = $True }
                    
                    If ( $X[$_] -eq 0 ) 
                    { 
                        $Code.$Y          = '-' 
                    }

                    If ( $X[$_] -eq 1 ) 
                    { 
                        $Code.$Y          = $X[$_]
                        $GUI.$Y.IsEnabled = $B[$Default[$P][$_]]
                        $Return          += $Y 
                    }
                }
        # ______________________________________________________________________________ #
        # Paths
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Names                        = Provision-DSCPromoTable -Paths
            $Default                      = "NTDS" , "NTDS" , "SYSVOL" | % { "C:\Windows\$_" }
            
                0..( $Names.Count - 1 )   | % { 

                    $Y                    = $Names[$_]
                    $Code.$Y              = $Default[$_]
                    $GUI.$Y.Text          = $Default[$_]
                }
        # ______________________________________________________________________________ #
        # Domain
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            $Names                        = Provision-DSCPromoTable -Domain
            $Switch                       = @{ 0 = 0,1,1,0,0,0,1 ; 1 = 1,0,0,1,1,0,1 ; 2 = 1,0,0,1,1,0,1 ; 3 = 1,1,0,0,0,1,1 }
            
            $X                            = $Switch[$P]

                0..( $Names.Count - 1 ) | % { 
                    
                    $Y                    = $Names[$_]
                    $GUI.$Y               | % { $_.Text = "" }

                    If ( $X[$_] -eq 0 ) 
                    { 
                        $Code.$Y          = '-' ; 
                        $GUI."$Y`Box"     | % { $_.Visibility = "Collapsed" }
                    }

                    If ( $X[$_] -eq 1 ) 
                    { 
                        $Code.$Y          = ''
                        $GUI."$Y`Box"     | % { $_.Visibility =   "Visible" }
                        $Return          += $Y
                    }
                }

        # ______________________________________________________________________________ #
        # DSRM
        # ¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯ #
            "Credential" | % {
                
                $GUI.$_                   | % { $_.IsEnabled = $False ; $_.Text = "" }
                $Code.$_                  = ""
                $Return                  += "SafeModeAdministratorPassword"
            
            }

            Return [ PSCustomObject ]@{ 
            
                Code                      = $Code
                Window                    = $GUI
                Profile                   = $Return 
            }
                                                                                     #____ -- ____    ____ -- ____    ____ -- ____    ____ -- ____      
}#____                                                                             __//¯¯\\__//==\\__/----\__//==\\__/----\__//==\\__/----\__//¯¯\\___  
#//¯¯\\___________________________________________________________________________/¯¯¯    ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯¯ ¯¯ ¯¯¯\\ 
#\\__//¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯        ____    ____ __ ____ __ ____ __ ____ __ ____ __ ____    ___// 
    Function Provision-DomainController # Launches Hybrid-DSCPromo ______________________//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯\\__//¯¯¯  
    {#/¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯ -- ¯¯¯¯    ¯¯¯¯      
        
        Write-Theme -Action "Searching [~]" "For Valid Domain Controllers" 11 12 15
        
        $Report     = Get-NBTScan | ? { $_.ID -eq "<1C>" } 

        Write-Theme -Action "Loading [~]" "Active Directory Configuration Utility" 11 12 15

        $P          = 0
        $GUI        = Get-XAML -HybridDSCPromo   | % { Convert-XAMLToWindow -XAML $_ -NE ( Find-XAMLNamedElements -Xaml $_ ) -PassThru }

        Get-DSCPromoSelection -Type $P -GUI $GUI | % { $Code = $_.Code ; $GUI = $_.Window ; $Return = $_.Profile }
        
        $Named      = Find-XAMLNamedElements -Xaml ( Get-XAML -HybridDSCPromo )
        
        $Menu       = Provision-DSCPromoTable -Menu

        0..( $Menu.Count - 1 ) | % { 
        
            IEX "`$GUI.`$( `$Menu[$_] ).Add_Click({ 
        
                Get-DSCPromoSelection -Type $_ -GUI `$GUI | % { 
            
                    `$Code   = `$_.Code ; 
                    `$GUI    = `$_.Window ; 
                    `$Return = `$_.Profile }
            })"
        }

        $Service    = Provision-DSCPromoTable -Services

        0..( $Service.Count - 1 ) | % {

            IEX "`$GUI.`$( `$Service[$_] ) | ? { `$_.IsEnabled } | % { 
        
            `$_.Add_UnChecked({ `$Code.`$( `$Service[$_] ) = 0 })
              `$_.Add_Checked({ `$Code.`$( `$Service[$_] ) = 1 }) 
            }"
        }

        $GUI.CredentialButton.Add_Click({ 

            $Alternate = 0
            If ( $Report -ne $Null ) 
            {
                $Report | % { $DC = $_.Host.Split( '.' )[0] ; $Domain = $_.Host.Replace( "$DC." , '' ) ; $NetBIOS = $_.Name }

                $PopupXAML     = Get-XAML -DCFound
                $PopupNamed    = "DC" , "Domain" , "NetBIOS" , "Ok" , "Cancel"
                $PopupGUI      = @{ Xaml = $PopupXaml ; Passthru = $True ; EA = 0 ; NE = $PopupNamed }
                $Popup         = Convert-XAMLToWindow @PopupGUI

                $Popup.Ok.Add_Click({     $Popup.DialogResult = $True  })
                $Popup.Cancel.Add_Click({ $Popup.DialogResult = $False })

                $Popup.DC      | % { $_.Content = $DC      }
                $Popup.Domain  | % { $_.Content = $Domain  }
                $Popup.NetBIOS | % { $_.Content = $NetBIOS }

                $Null = $Popup.Ok.Focus()

                $PopupResult = Show-WPFWindow -GUI $Popup

                If ( $PopupResult -eq $True )
                {
                    $DCCred = Enter-ServiceAccount -DC $DC -Domain $Domain
                }

                Else 
                {
                    $Alternate = 1
                }
            }

            If ( ( $Report -eq $Null ) -or ( $Alternate -eq 1 ) )
            {
                $X = $( If ( $Code.Process -in 1,2 ) { $GUI.ParentDomainName.Text }
                        If ( $Code.Process -eq 3   ) { $GUI.DomainName.Text       } )

                If ( ( $X -eq "" ) -or ( $X -eq $Null ) )
                {
                    [ System.Windows.MessageBox ]::Show( "Domain Name is Null/Empty" , "Error" ) ; Return
                }

                Else
                {
                    $X | % {

                        If ( ( Validate-DomainName -Domain -Name $X ) -ne $X )
                        { 
                            [ System.Windows.MessageBox ]::Show( "$X in Parent Domain Name" , "Error" ) ; Return
                        }
                    
                        Else
                        {
                            Resolve-DNSName $_ -Type A | % { Resolve-DNSName $_.IPAddress } | % { $Y = $_.NameHost.Replace( ".$X" , '' ) }
                            If ( $Y -eq $Null ) { [ System.Windows.MessageBox ]::Show( "Failed to detect the domain controller" , "Error" ) ; Return }
                        }
                    }

                    $DCCred = Enter-ServiceAccount -DC $Y -Domain $X 
                }
            } 

            If ( $DCCred -ne $Null ) 
            { 
                $GUI.Credential.Text = $DCCred.UserName
                $Code.Credential     = $DCCred

                If ( $Code.Process -in 1 , 2 ) 
                {
                    $GUI.ParentDomainName.Text = $X
            
                    $AD = "LDAP://$( $DC )/CN=Partitions,CN=Configuration,DC=$( $Domain.Split('.') -join ',DC=' )"

                    $Searcher = [ DirectorySearcher ]::New() | % {
                        $_.SearchRoot = [ DirectoryEntry ]::New( $AD , $DCCred.Username , $DCCred.GetNetworkCredential().Password )
                        $_.PageSize   = 1000
                        $_.PropertiesToLoad.Clear()
                    }

                    $EXE = $Searcher.FindAll()
                    0..( $EXE.Count - 1 ) | % { $EXE[$_].Properties } | ? { $_.netbiosname } | % { $NBIOS = $_.netbiosname }
                }

                Else { $GUI.DomainName.Text = $X }
            }

            If ( $DCCred -eq $Null )
            {
                Write-Theme -Action "Exception [!]" "Login Failed" 12 4 15 
            }
        })

        $GUI.Cancel.Add_Click({ $GUI.DialogResult = $False })

        $Return

    }


    
